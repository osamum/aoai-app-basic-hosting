# 演習 5-1 : 演習 5-1 : OpenAI サービスの閉域化設定

Azure Virtual Network リソースをデプロイして仮想ネットワーク環境を作成し、Azure OpenAI サービスに対してプライベート エンドポイントを作成します。

その後、同じ仮想ネットワーク内に Azure 仮想マシンをデプロイし、名前解決を含めた接続を確認します。

実行する作業は以下のとおりです。

1. 仮想ネットワーク環境の作成
2. Azure OpenAI サービスのプライベート エンドポイント作成
3. Azure 仮想マシンのデプロイと接続確認

<br>

## タスク 1 : 仮想ネットワーク環境の作成

Azure Portal を使用して仮想ネットワーク環境を作成します。

具体的な手順は以下のとおりです。

1. Azure Portal [ホーム画面](https://portal.azure.com/#home) の上部の検索ボックスに `仮想ネットワーク` と入力し、検索結果から `仮想ネットワーク` を選択します

    <img src="images/AzureVnet_Find.png" width="700px">

2. \[**仮想ネットワーク**\] の画面に遷移するので、画面上部にある \[**+ 作成**\] ボタンをクリックします

3. \[**仮想ネットワークの作成**\] 画面の \[**基本**\] タブに遷移するので、各項目を以下のように設定します

    |項目|設定値|
    |:---|:---|
    |サブスクリプション|使用するサブスクリプション|
    |リソース グループ|\[**AOAI-AppEnv-handson**\]|
    |名前|`handson-eastus-vnet`|
    |リージョン|\[**(US) East US**\]|
    
    <img src="images/AzureVnet_Create_Standerd.png" width="700px">

    設定が完了したら \[**次: セキュリティ**\] ボタンをクリックします

4. \[**セキュリティ**\] タブに遷移するので、各項目を以下のように設定します

    **Azure Bastion**

    |項目|設定値|
    |:---|:---|
    |Azure Bastion を有効にする|\[**Bastion を有効にする**\]|
    |Azure Bastion ホスト名|`handson-eastus-vnet-Bastion`(※既定のまま)|
    |Azure Bastion のパブリック IP アドレス|入力ボックス下の \[パブリック IP アドレスを作成\] リンクをクリックし、表示された\[**パブリック IP アドレス**\] ダイアログ ボックスで既定の設定のまま \[**OK**\] ボタンをクリック|

    **Azure Firewall** と **Azure DDoS ネットワーク保護** は既定のままとします

    <img src="images/AzureVnet_Create_Security.png" width="700px">
   
   設定が完了したら \[**次: IP アドレス**\] ボタンをクリックします

5. \[**IP アドレス**\] タブに遷移するので、アドレス空間情報が表示されているボックスの \[**サブネット**\] フィールドの **default**　をクリックします

    <img src="images/AzureVnet_Create_IPAddress.png" width="700px">

6. 画面右に \[**サブネットの編集**\] ブレードが表示されるので、各項目を以下のように設定します

    |項目|設定値|
    |:---|:---|
    |サブネットの目的|`Default`|
    |名前 \*|`handson-subnet`|
    
    **IPv4**、**IPv6**、**プライベート サブネット**、**セキュリティ** はすべて既定のままです

    <img src="images/AzureVnet_Create_Subnet.png" width="700px">

    設定が完了したら \[**保存**\] ボタンをクリックし\[**サブネットの編集**\] ブレードを閉じます

7. \[**レビューと作成**\] ボタンをクリックし、\[**作成**\] ボタンが表示されたらクリックします 

ここまでの手順で仮想ネットワーク環境の作成は完了です。

<br>

## タスク 2 : Azure OpenAI サービスのプライベート エンドポイント作成

仮想ネットワーク環境に Azure OpenAI サービスを公開するためのプライベート エンドポイントを作成します。

具体的な手順は以下のとおりです。

1. [Azure ポータル](https://portal.azure.com)でこの演習で使用している Azure OpenAI サービスのリソース ページを開き、画面左のメニューから \[リソース管理\] - \[**ネットワーク**\] を選択します

    遷移した画面で \[**Private endpoint connections**\] タブを選択し、画面上部の \[**+ Private endpoint**\] ボタンをクリックします

    ![OpenAI サービスへのプライベート エンドポイントの追加](images/AOAI_add_privateEndpoint.png)

2. \[**プライベート エンドポイントを作成する**] 画面に遷移するので、各項目を以下のように設定します

    **プロジェクトの詳細**

    |項目|設定値|
    |:---|:---|
    |サブスクリプション|使用するサブスクリプション|
    |リソース グループ|\[**AOAI-AppEnv-handson**\]|

    **インスタンスの詳細**

    |項目|設定値|
    |:---|:---|
    |名前 \*|`handson-aoai-endpoint`|
    |ネットワーク インターフェイス名 \*|(自動生成されるもの)|
    |地域 \*|\[**(US) East US**\]|

    <img src="images/AOAI_create_privateEndpoint.png" width="800px">

    設定が完了したら \[**次: リソース >**\] ボタンをクリックします

3. \[**リソース**\] 画面に遷移するので、各項目すべて既定のまま \[**次: 仮想ネットワーク >**\] ボタンをクリックします

    ![OpenAI サービスへのプライベート エンドポイント - リソース設定](images/AOAI_PrivateEndpoint_Resource.png)

4.  \[**仮想ネットワーク**\] 画面に遷移するので、各項目が以下のように設定されていることを確認します

    **ネットワーク**

    |項目|設定値|
    |:---|:---|
    |仮想ネットワーク \*|\[**handson-eastus-vnet (AOAI-AppEnv-handson)**\]|
    |サブネット \*|\[**handson-subnet**\]|


    **プライベート IP 構成**

    |項目|設定値|
    |:---|:---|
    |IP アドレスを動的に割り当てる|チェックする|

    **アプリケーション セキュリティ グループ**

    なにも指定しない (既定のまま)

    <img src="images/AOAI_PrivateEndpoint_setvnet.png" width="800px">

    設定が完了したら \[**次: DNS >**\] ボタンをクリックします

5. \[**DNS**\] 画面に遷移するので既定のままなにも設定せず \[**次: タグ >**\] ボタンをクリックします

6. \[**タグ**\] 画面に遷移するので同様に既定のままなにも設定せず \[**次: 確認および作成 >**\] ボタンをクリックします

7. \[**作成**\] ボタンが有効になったらクリックします

    ここまでの手順でプライベート エンドポイントの作成は完了です。

    この設定で演習で使用している Azure OpenAI リソースは仮想ネットワーク **handson-eastus-vnet** 内の環境からアクセス可能になりました。

    なお、この段階ではまだインターネットからもアクセスできる状態となっています。

<br>

## タスク 3 : Azure 仮想マシンのデプロイと接続確認

> [!Note] 操作中 `お使いのサブスクリプションでは、East US での仮想マシンの作成がサポートされていません。別の場所を選んでください` というメッセージが表示される場合はこの手順をスキップしてください。この内容は***でもカバーされます。

仮想ネットワーク環境内からこの演習で使用している Azure OpenAI リソースのエンドポイントにアクセスできることを確認します。

これには、仮想ネットワーク環境内にテスト用の仮想マシンを作成し、その仮想マシンのコンソールからエンドポイントにアクセスします。

仮想マシンからアプリケーションへの正常な接続を確認後、インターネットからアプリケーションへの接続を無効にします。

具体的な手順は以下のとおりです。

\[**手順**\]


1.  [Azure Portal](http://portal.azure.com) にログインし、ポータル画面上部の \[**+**\] リソースの作成 アイコンか、表示されていない場合は画面左上のハンバーガーメニューをクリックし、\[**リソースの作成**\] をクリックします

    ![Create Resource](images/23aug_create_AzureResource.png)

2. \[**リソースの作成**\] 画面に遷移するので、検索ボックスに `仮想マシン` と入力し、表示された検索結果の \[**仮想マシン**\] のタイルをクリックします

    ![仮想マシンの検索](images/VM_tail.png)

4. \[**仮想マシン**\] の画面に遷移するので、\[**作成**\] ボタンをクリックします


2. \[**仮想マシンの作成**\] の画面の \[**基本**\] タブに遷移するので各項目を以下のように設定します

    **プロジェクトの詳細**

    |項目|設定値|
    |:---|:---|
    |サブスクリプション \*|使用するサブスクリプション|
    |リソース グループ|\[**AOAI-AppEnv-handson**\]|

    **インスタンスの詳細**

    |項目|設定値|
    |:---|:---|
    |仮想マシン名 \*|`aoai-mon-vm`|
    |地域 \*|\[**(US) East US**\]|
    |可用性オプション|\[**インフラストラクチャ冗長は必要ありません**\]|
    |セキュリティの種類|\[**Standard**\]|
    |イメージ \*|\[**[Ubuntu Server 24.04 LTS - x64 Gen2]**\](※ Bash が動作するものであればどれでもかまいません)|
    |VM アーキテクチャ|\[**x64**\]|
    |サイズ|(※任意のものを選択します。価格の安いものでかまいません)|

    **管理者アカウント**

    |項目|設定値|
    |:---|:---|
    |認証の種類 \*|\[**パスワード**\]|
    |ユーザー名 \*|`handson-vmadmin`|
    |パスワード \*|`P@ssw0rd1234`|
    |パスワードの確認 \*|`P@ssw0rd1234`|

    **受信ポートの規則**

    |項目|設定値|
    |:---|:---|
    |パブリック受信ポート \*|\[**なし**\]|

    <img src="images/vm_mon_aoai.png" width="700px">

    設定が完了したら \[**次: ディスク >**\] ボタンをクリックします

3. \[**ディスク**\] タブの画面に遷移しますが、既定のままで \[**次: ネットワーク >**\] ボタンをクリックします

    なお、\[**OS ディスクの種類**\]　で、より安価なディスクを選択してもかまいません。

4. \[**ネットワーク**] タブの画面に遷移するので各項目が既定で以下のように設定されていることを確認します

    **ネットワーク インターフェイス**

    |項目|設定値|
    |:---|:---|
    |仮想ネットワーク \*|\[**handson-vnet**\]|
    |サブネット \*|\[**handson-subnet (10.0.0.0/24)**\]|
    |パブリック IP|\[**(新規) vnet-mon-vm-ip**\]|
    |NIC ネットワーク セキュリティ グループ|\[**詳細**\ にチェック]|
    |ネットワーク セキュリティ グループの構成 /*|\[**(新規) vnet-mon-vm-nsg**\]|
    |VM が削除されたときにパブリック IP と NIC を削除する|チェックしない(※任意)|
    |高速ネットワークを有効にする|チェック|

    **負荷分散**

    |項目|設定値|
    |:---|:---|
    |負荷分散のオプション|\[**なし**\]にチェック|





    