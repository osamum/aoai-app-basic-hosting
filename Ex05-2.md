
# 演習 5-2 : AI Search の閉域化設定

[演習 5 : サービスの閉域化](Ex05.md) と同様にAzure Virtual Network リソースをデプロイして仮想ネットワーク環境を作成し、Azure AI Search サービスに対してプライベート エンドポイントを作成します。

その後、同様に作成した仮想ネットワーク内に Azure 仮想マシンをデプロイし、名前解決を含めた接続を確認します。ただし、今回は Windows 仮想マシンをデプロイします。

また、この演習で作成する仮想ネットワーク `handson-japaneast-vnet` から、[演習 5-1 : OpenAI サービスの閉域化設定](Ex05-1.md) で作成した仮想ネットワーク `handson-japaneast-vnet` へ 仮想ネットワーク ピアリングを設定し、両リージョン間での通信ができるようにします。 

実行する作業は以下のとおりです。

1. 仮想ネットワーク環境の作成
2. Azure AI Search のプライベート エンドポイント作成
3. Azure 仮想マシンのデプロイと接続確認
4. 仮想ネットワークのピアリング設定

<br>

## タスク 1 : 仮想ネットワーク環境の作成

Azure Portal を使用して仮想ネットワーク環境を作成します。

操作手順としては、デプロイするリージョン、仮想ネットワークとサブネットの名前、アドレス空間、以外は [演習 5 : サービスの閉域化](Ex05.md)と同様です。

具体的な手順は以下のとおりです。

1. Azure Portal [ホーム画面](https://portal.azure.com/#home) の上部の検索ボックスに `仮想ネットワーク` と入力し、検索結果から `仮想ネットワーク` を選択します

    <img src="images/AzureVnet_Find.png" width="700px">

2. \[**仮想ネットワーク**\] の画面に遷移するので、画面上部にある \[**+ 作成**\] ボタンをクリックします

3. \[**仮想ネットワークの作成**\] 画面の \[**基本**\] タブに遷移するので、各項目を以下のように設定します

    |項目|設定値|
    |:---|:---|
    |サブスクリプション|使用するサブスクリプション|
    |リソース グループ|\[**AOAI-AppEnv-handson**\]|
    |名前|`handson-jpeast-vnet`|
    |リージョン|\[**(Asia Pacific) Japan East**\]|

    <img src="images/AzureVnet_Create_jpeast.png" width="700px">

    設定が完了したら \[**次: セキュリティ**\] ボタンをクリックします

4. \[**セキュリティ**\] タブに遷移するので、各項目を以下のように設定します

    **Azure Bastion**

    |項目|設定値|
    |:---|:---|
    |Azure Bastion を有効にする|\[**Bastion を有効にする**\]|
    |Azure Bastion ホスト名|`handson-jpeast-vnet-Bastion`(※既定のまま)|
    |Azure Bastion のパブリック IP アドレス|入力ボックス下の \[パブリック IP アドレスを作成\] リンクをクリックし、表示された\[**パブリック IP アドレス**\] ダイアログ ボックスで既定の設定のまま \[**OK**\] ボタンをクリック|

    **Azure Firewall** と **Azure DDoS ネットワーク保護** は既定のままとします

    <img src="images/AzureVnet_Create_Security_jpeast.png" width="700px">

   設定が完了したら \[**次: IP アドレス**\] ボタンをクリックします

5. \[**IP アドレス**\] タブに遷移するので、アドレス空間情報が表示されているボックスには以下のように表示されているのを確認します

    ```
    このアドレス プレフィックスは、仮想ネットワーク 'handson-eastus-vnet' と重複しています。これらの仮想ネットワークをピアリングする場合は、アドレス空間を変更してください
    ```

   アドレス範囲の `10.0.0.0/16` を `10.1.0.0/16` に変更します

    \[**サブネット**\] フィールドの **default**　をクリックします

    <img src="images/AzureVnet_Create_IpRange.png" width="700px">

6. 画面右に \[**サブネットの編集**\] ブレードが表示されるので、各項目を以下のように設定します

    |項目|設定値|
    |:---|:---|
    |サブネットの目的|`Default`|
    |名前 \*|`handson-subnet`|
    
    **IPv4**、**IPv6**、**プライベート サブネット**、**セキュリティ** はすべて既定のままです

    <img src="images/AzureVnet_Create_Subnet.png" width="700px">

    設定が完了したら \[**保存**\] ボタンをクリックし\[**サブネットの編集**\] ブレードを閉じます

7.  \[**レビューと作成**\] ボタンをクリックし、\[**作成**\] ボタンが表示されたらクリックします 

ここまでの手順で仮想ネットワーク環境の作成は完了です。

<br>

## タスク 2 : Azure AI Search のプライベート エンドポイント作成

仮想ネットワーク環境に Azure AI Search サービスを公開するためのプライベート エンドポイントを作成します。

具体的な手順は以下のとおりです。

1. [Azure ポータル](https://portal.azure.com)でこの演習で使用している Azure AI Search のリソース ページを開き、画面左のメニューから \[設定\] - \[**ネットワーク**\] を選択します


    遷移した画面で \[**プライベート エンドポイント接続**\] タブを選択し、画面上部の \[**+ プライベート エンドポイントを作成する**\] ボタンをクリックします

    ![OpenAI サービスへのプライベート エンドポイントの追加](images/AISearch_add_privateEndpoint.png)

2. \[**プライベート エンドポイントを作成する**] 画面に遷移するので、各項目を以下のように設定します

    **プロジェクトの詳細**

    |項目|設定値|
    |:---|:---|
    |サブスクリプション|使用するサブスクリプション|
    |リソース グループ|\[**AOAI-AppEnv-handson**\]|

    **インスタンスの詳細**

    |項目|設定値|
    |:---|:---|
    |名前 \*|`handson-aisearch-endpoint`|
    |ネットワーク インターフェイス名 \*|(自動生成されるもの)|
    |地域 \*|\[**(Asia Pacific) Japan East**\]|

    <img src="images/AISearch_create_privateEndpoint.png" width="800px">

    設定が完了したら \[**次: リソース >**\] ボタンをクリックします

3. \[**リソース**\] 画面に遷移するので、各項目を以下のように設定します

    |項目|設定値|
    |:---|:---|
    |接続方法|\[**マイ ディレクトリ内の Azure リソースに接続します。**\]にチェック|
    |サブスクリプション\*|*お使いのサブスクリプション*|
    |リソースの種類 \*|\[**Microsoft.Search/searchServices**\]|
    |リソース \*|\[**(この演習で使用している Azure AI Search リソース名)**\]|
    |対象サブリソース \*|\[**searchService**\]|  
    
    ![AI Search プライベートエンドポイント リソースの設定](images/AISearch_create_privateEndpoint_resource.png)
    
    設定が完了したら \[**次: 仮想ネットワーク >**\] ボタンをクリックします

4.  \[**仮想ネットワーク**\] 画面に遷移するので、各項目が以下のように設定されていることを確認します

    **ネットワーク**

    |項目|設定値|
    |:---|:---|
    |仮想ネットワーク \*|\[**handson-jpeast-vnet (AOAI-AppEnv-handson)**\]|
    |サブネット \*|\[**handson-subnet**\]|


    **プライベート IP 構成**

    |項目|設定値|
    |:---|:---|
    |IP アドレスを動的に割り当てる|チェックする|

    **アプリケーション セキュリティ グループ**

    なにも指定しない (既定のまま)

    <img src="images/AOAI_PrivateEndpoint_setvnet_jpeast.png" width="800px">

    設定が完了したら \[**次: DNS >**\] ボタンをクリックします

5. \[**DNS**\] 画面に遷移するので既定のままなにも設定せず \[**次: タグ >**\] ボタンをクリックします

6. \[**タグ**\] 画面に遷移するので同様に既定のままなにも設定せず \[**次: 確認および作成 >**\] ボタンをクリックします

7. \[**作成**\] ボタンが有効になったらクリックします

    ここまでの手順でプライベート エンドポイントの作成は完了です。

    この設定で演習で使用している Azure AI Searchは仮想ネットワーク **handson-jpeast-vnet** 内の環境からアクセス可能になりました。

    なお、この段階ではまだインターネットからもアクセスできる状態となっています。

<br>

## タスク 3 : Azure 仮想マシンのデプロイと接続確認

仮想ネットワーク環境内からこの演習で使用している Azure AI Search リソースのエンドポイントにアクセスできることを確認します。

これには、仮想ネットワーク環境内にテスト用の仮想マシンを作成し、その仮想マシンのコンソールからエンドポイントにアクセスします。

今回デプロイする仮想マシンはこれ以降、仮想ネットワーク内の Azure リソースにアクセスするためのジャンプボックスとして使用するため、デスクトップ環境をもつ **Windows Server** をデプロイします。なお、外部ネットワークからこの仮想マシンに直接アクセス可能とはせず、[Azure Bastion](https://learn.microsoft.com/ja-jp/azure/bastion/bastion-overview) 経由で接続するように構成します。

仮想マシンから Azure AI Search への正常な接続を確認後、インターネットからアプリケーションへの接続を無効にします。

具体的な手順は以下のとおりです。

\[**手順**\]


1.  [Azure Portal](http://portal.azure.com) にログインし、ポータル画面上部の \[**+**\] リソースの作成 アイコンか、表示されていない場合は画面左上のハンバーガーメニューをクリックし、\[**リソースの作成**\] をクリックします

    ![Create Resource](images/23aug_create_AzureResource.png)

2. \[**リソースの作成**\] 画面に遷移するので、検索ボックスに `仮想マシン` と入力し、表示された検索結果の \[**仮想マシン**\] のタイルをクリックします

    ![仮想マシンの検索](images/VM_tail.png)

3. \[**仮想マシン**\] の画面に遷移するので、\[**作成**\] ボタンをクリックします


4. \[**仮想マシンの作成**\] の画面の \[**基本**\] タブに遷移するので各項目を以下のように設定します

    **プロジェクトの詳細**

    |項目|設定値|
    |:---|:---|
    |サブスクリプション \*|使用するサブスクリプション|
    |リソース グループ|\[**AOAI-AppEnv-handson**\]|

    **インスタンスの詳細**

    |項目|設定値|
    |:---|:---|
    |仮想マシン名 \*|`handson-mon-vm`|
    |地域 \*|\[**(Asia Pacific) Japan East**\]|
    |可用性オプション|\[**インフラストラクチャ冗長は必要ありません**\]|
    |セキュリティの種類|\[**Standard**\]|
    |イメージ \*|\[**[Windows Server 2025 Datacenter:Azure Edition - x64 Gen2]**\]|
    |VM アーキテクチャ|\[**x64**\]|
    |サイズ|(※任意のものを選択します。価格の安いものでかまいません)|

    **管理者アカウント**

    |項目|設定値|
    |:---|:---|
    |認証の種類 \*|\[**パスワード**\]|
    |ユーザー名 \*|`handson-vmadmin`|
    |パスワード \*|`P@ssw0rd1234`|
    |パスワードの確認 \*|`P@ssw0rd1234`|

    **受信ポートの規則**

    |項目|設定値|
    |:---|:---|
    |パブリック受信ポート \*|\[**なし**\]|

    **ライセンス**

    |項目|設定値|
    |:---|:---|
    |既存の Windows Server ライセンスを使用しますか?|チェックしない|

    <img src="images/vm_mon_jpeast.png" width="700px">

    設定が完了したら \[**次: ディスク >**\] ボタンをクリックします

5. \[**ディスク**\] タブの画面に遷移しますが、既定のままで \[**次: ネットワーク >**\] ボタンをクリックします

    なお、\[**OS ディスクの種類**\]　で、より安価なディスクを選択してもかまいません。

6. \[**ネットワーク**] タブの画面に遷移するので各項目が既定で以下のように設定されていることを確認します

    **ネットワーク インターフェイス**

    |項目|設定値|
    |:---|:---|
    |仮想ネットワーク \*|\[**handson-eastus-vnet**\]|
    |サブネット \*|\[**handson-subnet (10.0.0.0/24)**\]|
    |パブリック IP|\[**なし**\]|
    |NIC ネットワーク セキュリティ グループ|\[**詳細**\ にチェック]|
    |ネットワーク セキュリティ グループの構成 /*|\[**(新規) handson-mon-vm-nsg**\]|
    |VM が削除されたときにパブリック IP と NIC を削除する|(※任意)|
    |高速ネットワークを有効にする|チェック|

    **負荷分散**

    |項目|設定値|
    |:---|:---|
    |負荷分散のオプション|\[**なし**\]にチェック|

     <img src="images/vm-mon-jpeast-createNetwork.png" width="700px">

    設定が完了したら \[**確認および作成**\] ボタンをクリックし、\[**作成**\] ボタンが有効になったらクリックしてデプロイを開始します。

7. 仮想マシンのデプロイが完了すると \[**リソースに移動**\] ボタンが表示されるので、クリックして作成した仮想マシンのリソース画面に遷移します

8. 画面左のメニューから \[**Bastion**\] をクリックし、遷移した画面の各項目を以下のように設定します

    |項目|設定値|
    |:---|:---|
    |キーボードの言語|\[**日本語**\]|
    |認証の種類|\[**VM パスワード**\]|
    |ユーザー名 \*|`handson-vmadmin`|
    |VM パスワード \*|`P@ssw0rd1234`|
    |新しいブラウザー タブで開く|**チェック**|

    <img src="images/vm-connect-jpeast-bastion.png" width="700px">

    設定が完了したら \[**接続**\] ボタンをクリックします

9. Web ブラウザーの新しいたタブが開き、仮想マシンへの接続が完了すると、Azure ポータル画面内に仮想マシンのデスクトップ画面が表示されるので、画面下部のタスクバーにあるスタートボタン(Windows アイコン)をクリックし、表示されたメニューから \[**Terminal**\] アイコンをクリックします

    ![仮想マシンのデスクトップ](images/vm-vastion-jpeast-connected.png)

10. Windows ターミナルが起動したら、仮想ネットワーク内の Azure AI Search リソースにアクセスできることを確認します

    ただし、Windows ターミナルは既定の状態では Bash コマンドは使用できないため PowerShell コマンドを記述します。 メモ帳などを使用して以下のようにコマンド内の `%AISEARCH-ENDPOINT%` と `%AISEARCH-APIKEY%` の部分を実際の値に置き換えたコマンドを作成します

    ```powershell
    $response = Invoke-WebRequest -Uri "%AISEARCH-ENDPOINT%/indexes?api-version=2024-07-01" `
    -Method Get `
    -Headers @{ "api-key" = "%AISEARCH-APIKEY%" }

    $response.Content
    ```

    作成したコマンドをコピーします

11. 仮想マシンのターミナル画面上でマウスの右ボタンをクリックすると、貼り付けに関する確認メッセージが表示されるので \[**Paste anyway**\] ボタンをクリックします

    ![Bastion 貼り付けの警告](images/Bastion_pate_confirm.png)    

    貼り付けられたコマンドを実行し、正しく応答が返ってくることを確認します。

    ![Bastion AI Search からの応答](images/bastion-respones-AISearch.png)

12. ローカルの開発環境のターミナル画面で、再度同じコマンドを実行します

    ローカルの開発環境が Mac や Linux の場合は以下の Bash コマンドを使用します。メモ帳などを使用して以下のようにコマンド内の `%AISEARCH-ENDPOINT%` と `%AISEARCH-APIKEY%` の部分を実際の値に置き換えたコマンドを作成します

    ```bash
    curl -i -X GET "%AISEARCH-ENDPOINT%indexes?api-version=2024-07-01" -H "api-key: %AISEARCH-APIKEY%"
    ```

    コマンドを実行し、正しく応答が返ってくることを確認します。

13. この演習で使用している Azure AI Search へのインターネットからのアクセスを無効にします

    Azure ポータルで、Azure AI Searchのリソース画面を開き、画面左のメニューから \[設定\] - \[**ネットワーク**\] を選択します。

    遷移した画面で \[**ファイヤーウォールと仮想ネットワーク**\] タブ内の \[**無効**\] オプションボタンをクリックします。

    \[**このサービスのエンドポイント接続をプライベートにしますか?**\] という確認メッセージが表示されるので \[**OK**\] ボタンをクリックします。

    ![OpenAI サービスのパブリック エンドポイント設定](images/AISearch_network_limitate.png)

    画面下部の \[**保存**\] ボタンをクリックします
    
14. ローカルの開発環境のターミナル画面で、再度同じコマンドを実行し、以下のようなエラーが返されることを確認します

    ```json
    {"error":{"code":"","message":"Request is denied as the source is not allowed by applicable rules. The service is set 'publicNetworkAccess: Disabled'. Please review all service's network security settings to ensure the client is allowed."}}
    ```
15. 仮想マシンのターミナル画面に戻り、同じコマンドを実行し、正常に応答が返されることを確認します
