# 演習 2-3-3 : Azure AI Search 関連のバックアップ

Azure AI Search の検索機能を構成している要素は以下の 2 つに大別され、それぞれにバックアップとリストア方法が異なります。

1. Azure AI Search のサービス (インスタンス)
2. AI Search サービス内のインデックス、スキルセット、データソース、インデクサー等の設定

この演習では、Azure AI Search サービスのバックアップとリストアを行い、インデックスを復旧する方法を学びます。

<br>

## 1. Azure AI Search サービスのバックアップ

Azure AI Search のサービス (インスタンス) には、ディスク上のイメージを取得するようないわゆる一般的なバックアップ機能はありませんが、構造とインスタンス固有の情報は ARM テンプレート、あるいは Bicep とパラメーターを保持しておけばこれらを使用して再デプロイを行うことで復旧が可能です。


**復旧時に引き継がれるもの**

ARM テンプレート/Bicep に含まれていれば、以下の構成が復旧可能です：

* サービス名、SKU、リージョン
* レプリカ数、パーティション数
* ネットワーク設定（IP制限、Private Link など）
* 暗号化設定（CMK など）※ただし、Key Vault のアクセス権も別途設定が必要

ただし、管理者キーやアクセス制御 (AIM) の設定は含まれませんので、復旧後に再設定が必要です。

アプリケーションが Azure AI Search サービスへのアクセスに管理者キーを使用している場合は、復旧後に再取得する必要がありますが、マネージド ID を使用している場合は、Bicep で `roleAssignments` リソースを使用してアクセス制御 (AIM) の設定をテンプレート化しておくことができます。

以下は、ユーザー アカウントに対し、Azure AI Search サービスの `Search Service 共同作成者` ロールを割り当てる Bicep の例です。

```bicep
resource roleAssignment 'Microsoft.Authorization/roleAssignments@2020-04-01-preview' = {
  name: guid(resourceGroup().id, 'SearchServiceContributor')
  properties: {
    roleDefinitionId: subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'de139f84-1756-47ae-9be6-808fbbe84772')
    principalId: '<ユーザーまたはサービスプリンシパルのオブジェクトID>'
    principalType: 'User'
  }
}
```
<br>

### 稼働している Azure AI Search インスタンスの Bicep テンプレートを取得

演習用にデプロイ済みの Azure AI Search インスタンスの Bicep テンプレートを Azure ポータルを使用して取得します。

具体的な手順は以下の通りです。

\[**手順**\]

1. [Azure Portal](https://portal.azure.com/) にログインし、この演習で使用している Azure AI Search の画面を表示します

2. 左側のメニューから \[オートメーション\] - \[**テンプレートのエクスポート**\]を選択します

3. \[**テンプレートのエクスポート**\] 画面が表示されるので、\[**Bicep**\] タブをアクティブにし、画面上部の \[**ダウンロード**\] メニューをクリックします

    ![AISearch_export_bicep.png](images/AISearch_export_bicep.png)

4. Zip ファイルがダウンロードされるので任意の場所に保存し、解凍して　Bicep ファイルが含まれていることを確認します

   ![AISearch_export_bicep.png](images/AISearch_downloaded_bicep.png)

   Bicep ファイルはこのあとの演習で使用するので取り出しておいてください。

ここまでの手順で、演習用 Azure AI Search のインスタンスの Bicep テンプレートを取得できました。







AISearch_export_bicep.png






``` bash
az deployment group create \
  --resource-group <リソースグループ名> \
  --template-file iam-role.bicep
```