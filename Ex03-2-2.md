# 演習 3-2-2 : スケールアップの設定

サービスのスケールアップとは、文字通りサーバーの処理能力（スケール）を垂直方向に向上させる方法です。具体的には CPU、メモリ、ディスク領域を増やしたり、さまざまな専用のオプション機能を選択可能になります。

ただし、スケールアップにはサービスのダウンタイムが発生する可能性があるため、注意が必要です。スケールアップは、サーバーの性能を向上させるための最も簡単な方法ですが、物理的な制約により限界があります。

Azure のリソースのスケールアップは物理的なハードウェアの変更を伴わないため、Azure ポータルや CLI ツールを使用してプランを変更するだけで簡単に行うことができます。

## 🌐 App Service のスケールアップ

App Service のスケールアップは、Azure ポータルを使用したスケールアップの手順を確認しますが、メニューからプランを選択するだけなので、この演習では実際に操作は行わず UI を確認するだけで終了とします。

具体的な手順については、以下の公式ドキュメントの内容をご参照ください。

* [**Azure App Service でアプリをスケールアップする - 価格レベルのスケールアップ**](https://learn.microsoft.com/ja-jp/azure/app-service/manage-scale-up#scale-up-your-pricing-tier)

<br>

## 🛢️ Storage アカウントのスケールアップ

Azure Storage アカウントのスケールアップは、ストレージ アカウントのパフォーマンスを向上させるために、ストレージ アカウントの種類を変更することを指します。Azure Storage では、Standard と Premium の 2 つのストレージ アカウントの種類があり、Premium ストレージ アカウントは高いパフォーマンスを提供します。

既存の Standard ストレージ アカウントを Premium ストレージ アカウントに変更することはできません。新しい Premium ストレージ アカウントを作成し、データを移行する必要があります。ただし、Azure サポートに問い合わせることで、Standard ストレージ アカウントのまま高い容量とイングレスの制限を要求することもできます。

この演習では実際に操作は行わず UI を確認するだけで終了とします。

詳しくは以下のドキュメントをご参照ください。

* Standard Storage アカウントのスケーラビリティとパフォーマンスのターゲット - [**Standard Storage アカウントのスケール ターゲット**](https://learn.microsoft.com/ja-jp/azure/storage/common/scalability-targets-standard-account?toc=%2Fazure%2Fstorage%2Fblobs%2Ftoc.json&bc=%2Fazure%2Fstorage%2Fblobs%2Fbreadcrumb%2Ftoc.json#scale-targets-for-standard-storage-accounts)

<br>

## 🔍 AI Search のスケールアップ

Azure AI Search では、パーティション数とレプリカ数を増やすことでスケールアップを行います。これにより、以下のような効果が得られます：

* パーティション数の増加：より多くのデータを格納可能に
* レプリカ数の増加：クエリのスループット向上と高可用性の確保

この設定は、演習 [AI Search の可用性ゾーンの設定](Ex02-5-1.md#-ai-search-%E3%81%AE%E5%8F%AF%E7%94%A8%E6%80%A7%E3%82%BE%E3%83%BC%E3%83%B3%E3%81%AE%E8%A8%AD%E5%AE%9A) で確認した Azure ポータルの AI Search 画面 \[設定\] - \[**スケーリング**\] メニューで行えます。また、同画面内の \[**価格レベルの変更**\] をクリックして、より大きい値を指定可能な価格レベルに変更することもできます。 

この演習では実際に操作は行わず UI を確認するだけで終了とします。

手順と詳細については以下のドキュメントをご参照ください。

* [**Azure AI Search のサービス レベルを選択する**](https://learn.microsoft.com/ja-jp/azure/search/search-sku-tier#partition-size-and-speed)

<br>

## 🧠 Azure OpenAI Service のスケールアップ

Azure OpeAI Service の性能を向上させる方法としては一般的な IT システムの性能として要求されるスループットやレイテンシ以外に時間当たりに処理できるトークン数を増やすことが挙げられます。

言語モデルが 1 分間に処理できるトークン数は既定で制限されており、これを利用する SKU の範囲で変更することができます。

### タスク 1 : 言語モデルの 1 分あたりのトークン数レート制限を増やす

演習で使用している Azure OpenAI サービスの言語モデルは [Standard](https://learn.microsoft.com/ja-jp/azure/ai-foundry/openai/how-to/deployment-types#standard) デプロイを使用しており、現在の 1 分あたりのトークン数 (TPM) レート制限を引き上げることにより、より多くの情報を処理できるようになります。

具体的な手順は以下のとおりです。

\[**手順**▶️\]

1. [Azure AI Foundry](https://ai.azure.com/resource/)にログインし、ロゴ \[**Azure AI Foundry | Azure OpenAI**\] の右側にあるドロップダウンリスト ボックスをクリックし、この演習で使用している Azure OpeAI Service のリソースを選択します

    選択したリソースの画面に遷移したら画面左のメニューから \[**デプロイ**\] を選択します

    ![AOAI デプロイの選択](images/AIFoundry_choose_deploy.png)

2. \[**デプロイ**] 画面に遷移し、AI モデルの一覧が表示されるので、\[**gpt-4o-mini**\] のモデルをクリックします

3. \[**gpt-4o-mini**\] の画面に遷移するので、\[詳細\] タブがアクティブになっていることを確認し、画面上部の \[**編集**\] ボタンをクリックします

    ![価格レベルの変更](images/LLM_Edit_prop.png)

4. \[**gpt-4o-mini のデプロイを更新する**\] ダイアログボックスが表示されるので、同ダイアログボックス内の \[**1 分あたりのトークン数レート制限**\] のスライダーを操作し、任意の値に引き上げます。

    RAG で使用するデータベースが返す情報の量が多い場合や、Web 検索等を行う場合には最大値にしておくとトークン数の制限によるエラーの発生を緩和できます。

    ![価格レベルの変更](images/LLM_change_tokenLimit.png)

    設定が完了したら \[**変更内容の送信**\] ボタンをクリックします。

ここまでの手順で Azure OpeAI Service の言語モデルの 1 分あたりのトークン数レート制限の上限を変更することができました。

<br>

### タスク 2 : Standard デプロイのレート制限を増やす

サービスが利用する Token の量が [Standard](https://learn.microsoft.com/ja-jp/azure/ai-foundry/openai/how-to/deployment-types#standard) デプロイで提供されるクォータの制限内に収まらない場合は、クォータの引き上げの要求を行うことができます。

Azure Poral からのクォータの引き上げの要求の申請手順は以下のとおりです。

>[!Note]
>このタスクは手順を確認するのにとどめ、**実際の申請は行わないでください**。

\[**手順**📖\]

1. [Azure AI Foundry](https://ai.azure.com/resource/)にログインし、ロゴ \[**Azure AI Foundry | Azure OpenAI**\] の右側にあるドロップダウンリスト ボックスをクリックし、この演習で使用している Azure OpeAI Service のリソースを選択します

    選択したリソースの画面に遷移したら画面左のメニューから \[**デプロイ**\] を選択します

    ![AOAI デプロイの選択](images/AIFoundry_choose_deploy.png)

2. \[**デプロイ**] 画面に遷移し、AI モデルの一覧が表示されるので、\[**gpt-4o-mini**\] のモデルをクリックします

3. 遷移した画面の右上にある \[**クォータの申請**\] ボタンをクリックします

    ![クォータの申請](images/AIFoundry_request_quota.png)

4. クォーターの申請フォームが表示されるので、必要事項を記入して \[**送信**\] ボタンをクリックします
    
    ![クォータ申請フォーム](images/AIFoundry_quota_RequestForm.png)

ここまでの手順で Azure OpeAI Service のスケールアップのためのキャパシティ申請は完了です。完了後、Azure OpeAI Service のリソースを新規に作成する際に価格プランを選択することができます。

<br>

### タスク 3 : Azure OpenAI Service スループットとレイテンシの安定化

スループットとレイテンシの要件が明確に定義され、予測可能な場合は、標準(Standard) デプロイメントからプロビジョニングされたスループット(provisioned throughput)デプロイメントへの切り替えを検討します。プロビジョニングされたスループット・デプロイメントは、安定した最大レイテンシとスループットが保証されるため、リアルタイム性が重要なアプリケーションに最適です。

また、高スループットのワークロードでは、トークンベースの従量課金よりも[コストを抑えられる](https://learn.microsoft.com/ja-jp/azure/cost-management-billing/reservations/azure-ai-foundry)可能性があります。また、デプロイ時に必要な処理能力（GPUなど）が確保されるため、リソース不足による失敗を回避できます（ただし、クォータがあってもリージョンの容量が不足している場合は失敗する可能性もあります）。

プロビジョニングされたスループットについての詳細は以下のドキュメントをご参照ください。

* [**What is provisioned throughput?**](https://learn.microsoft.com/en-us/azure/ai-foundry/openai/concepts/provisioned-throughput?tabs=global-ptum)

プロビジョニングされたデプロイを作成する具体的な手順については、以下のドキュメントをご参照ください。

>[!Note]
>このタスクは手順を確認するのにとどめ、**実際の申請は行わないでください**。


* Get started using provisioned deployments on the Azure OpenAI in Azure AI Foundry Models - [**Create your provisioned deployment - capacity is available**](https://learn.microsoft.com/ja-jp/azure/ai-foundry/openai/how-to/provisioned-get-started?context=%2Fazure%2Fai-foundry%2Fcontext%2Fcontext#create-your-provisioned-deployment---capacity-is-available)

もしくは、以下の動画で手順を確認することもできます。

> [!VIDEO https://learn-video.azurefd.net/vod/player?show=azure-essentials-show&ep=deploy-openai-services-at-scale-using-provision-throughput-units#time=11m45s]

<iframe width="560" height="315" src="https://learn.microsoft.com/_themes/docs.theme/master/en-us/_themes/global/video-embed-one-stream.html?show=azure-essentials-show&ep=deploy-openai-services-at-scale-using-provision-throughput-units" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

<br>

## 次へ

👉　[**演習 3-2-3 : スケールアウトの設定**](Ex03-2-3.md)

---

👈　[演習 3-2-1. 可用性ゾーンの設定](Ex03-2-1.md)

🏚️　[README に戻る](README.md)



