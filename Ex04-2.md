# 演習 4-2 : マネージド ID によるサービス間認証

ここまでの作業で、演習用アプリケーションは Azure OpenAI と Azure AI Search に接続する際の認証情報として API キーを使用していました。演習 4-1 では、これを安全に管理するための Azure Key Vault の利用する方法について学びましたが、"認証に API キーを使用する" という点では同じです。より安全に Azure サービス間の認証を行うもう一つの方法として、Azure の[マネージド ID](https://learn.microsoft.com/ja-jp/entra/identity/managed-identities-azure-resources/overview) を利用する方法があります。

**マネージド ID とは**

マネージド ID は、Azure コンピューティング リソースに対して Azure AD による ID を自動的に割り当て、Azure リソースへの認証を簡素化する機能です。マネージド ID を使用すると、アプリケーション コード内で資格情報を管理する必要がなくなり、セキュリティが向上します。

この演習では、Azure App Service にシステム割り当てマネージド ID を有効化し、その ID に対して Azure OpenAI と Azure AI Search へのアクセス権を付与し、アプリケーションからそれらのサービスに接続する方法を説明します。

この演習で実施する作業は以下のとおりです。

1. OpenAI サービス、AI Search へのアクセス許可設定(開発ユーザー)
2. 演習用アプリケーションのコードの変更
3. OpenAI サービス、AI Search へのアクセス許可設定(App Service)
4. アプリケーションのデプロイと動作確認

<br>

## タスク 1 : OpenAI サービス、AI Search へのアクセス許可設定(開発ユーザー)

ローカル開発環境で実行する演習用アプリケーションから、 Azure OpenAI サービスと Azure AI Search にアクセスするためのアクセス許可設定を行います。

具体的な手順は以下のとおりです。

[**手順**]

1. Visual Studio Code から Azure にログインし、ログインしたユーザーの情報を確認します

    Visual Studio Code のメニュー \[View\] - \[Terminal\] をクリックし、表示されたターミナル ウィンドウで以下のコマンドを実行します。

    ```bash
    az login
    ```
    ログイン画面が表示され、Azure へのログインを求められるので指示に従ってログインしてください。ログインが完了したら、以下のコマンドを実行してログインしたユーザーの情報をメモ帳等で保持します。

    ```bash
    az account show
    ```

    この情報を使用して現在のユーザーアカウントに対して演習用アプリケーションが使用している Azure OpenAI Key Vault へのアクセス権を付与します。

2. [Azure ポータル](https://portal.azure.com/)にログインして、演習用アプリケーションが使用している Azure OpenAI サービスのプロパティ画面を開き、画面左のメニューから \[**アクセス制御(IAM)**\] を選択し、\[**+ 追加**\] - \[**ロールの割り当て**\] をクリックします

    ![Azure OpeAI ロール割り当ての追加メニュー](images/AOAI_IAM.png)

3. \[**ロール割り当ての追加**\] 画面の \[ロール\]タブに遷移し、ロールの一覧が表示されるので、\[**Cognitive Services OpenAI User**\] を選択し、画面下部の \[**次へ**\] ボタンをクリックします

    ![Azure OpeAI ロールの選択](images/AOAI_Role_SecretUser.png)

4. \[**メンバー**\] タブの画面に遷移するので、オプションボタン \[**アクセスの割り当て先**\] にチェックが付いた状態で、\[**+ メンバーを選択する**\] リンクをクリックします

    ![Azure OpeAI メンバーの選択](images/KeyVault_roll_addUser.png)

5. 画面右に\[**メンバーを選択する**\] ブレードが表示されるので、前の手順でメモ帳等に保持したログインユーザーのメールアドレスを検索ボックスに入力し、表示されたユーザーを選択して画面下部の \[**選択**\] ボタンをクリックします

6. ブレードが閉じるので画面下部の \[**レビューと割り当て**\] ボタンをクリックします

    ここまでの作業、現在 Visual Studio Code で作業しているユーザーに Azure OpenAI サービスの API へのアクセス権が付与されました。

7. 演習用アプリケーションが使用している Azure AI Search サービスのプロパティ画面を開き、ここまでの手順を参考に、Visual Studio Code で作業しているユーザーのアカウントに対しロールを割り当ててください。

    なお、Azure AI Search サービスで割り当てるロールは \[**検索インデックス データ閲覧者**\] です。

    ![Azure AI Search ロールの選択](images/AISearch_Role_SecretUser.png)

8. Azure AI Search 画面左のメニュー \[設定\] - \[**キー**\] をクリックします
   
   遷移した画面の項目 \[**API アクセス制御**\] で \[**両方**\] を選択し、「この検索サービスの API アクセス制御を更新しますか?」と表示されたら \[**はい**\] ボタンをクリックします。

   ![AI Search API アクセス制御](images/AISearch_API_accessControl.png)

    この設定を行わないと、マネジメント ID を使用して Azure AI Search サービスにアクセスすることができませんので注意が必要です。

ここまでの作業で、Visual Studio Code で作業しているユーザーのアカウントに対し、OpenAI サービス、AI Search の機能にアクセスするためのロールを割り当てることができました。

<br>

### タスク 2-2 : アプリケーション コードの変更 

Azure リソースにマネージド ID を利用したアクセスを行うための以下のモジュールをインストールし、モジュールが提供するメソッドを使用したコードを記述します。

* [Azure Identity client library for JavaScript](https://www.npmjs.com/package/@azure/identity)

なお、この変更は [演習 4-1-2 : アプリケーションからの Key Vault へのアクセス](Ex04-1.md#%E3%82%BF%E3%82%B9%E3%82%AF-2--%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%8B%E3%82%89%E3%81%AE-key-vault-%E3%81%B8%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9) で**実施したコードの変更とは互換がありません**。もし、それ以前のプロジェクトをバックアップされている場合はそちらを使用してください。

具体的な手順は以下のとおりです。

[**手順**]

1. Visual Studio Code で、演習用アプリケーションのプロジェクトを開きます

2. 演習用アプリケーションから へのアクセスを行うためのライブラリをインストールします
   
   Visual Studio Code の \[View\] - \[Terminal\] をクリックし、表示されたターミナル ウィンドウで以下のコマンドを順に実行します。

    ```bash
    npm install @azure/identity
    ```
3. プロジェクト内の **lm.js** ファイルを開き、ファイルの先頭にあるコメント `//[REPLACE:use_EntraID_authentication]` を以下のコードで置き換えます

    ```JavaScript
    const { 
    DefaultAzureCredential, 
    getBearerTokenProvider 
    } = require("@azure/identity");

    // keyless authentication    
    const credential = new DefaultAzureCredential();
    const scope = "https://cognitiveservices.azure.com/.default";
    const azureADTokenProvider = getBearerTokenProvider(credential, scope);
    ```
4. 同ファイル内の 68 行め付近にある以下のコメント下のコードを

    ```JavaScript
    //Azure OpenAI クライアントの初期化 (API キーを使用した認証)
    const client = new AzureOpenAI({ endpoint, apiKey, apiVersion, deployment });
    ```

    以下のコードで置き換えます

    ```JavaScript
    //Azure OpenAI クライアントの初期化 (Azure マネージド ID を使用した認証)
    const client = new AzureOpenAI({ endpoint, apiKey:'',azureADTokenProvider, deployment, apiVersion });
    ```

    キーボードの \[Ctrl\] + \[S\] を押下してファイルを保存します。

5. プロジェクト内の **imgGen.js** ファイルを開き、ファイルの先頭にあるコメント `//[REPLACE:use_EntraID_authentication]` を以下のコードで置き換えます

    ```JavaScript
    const { 
        DefaultAzureCredential, 
        getBearerTokenProvider 
    } = require("@azure/identity");

    // keyless authentication    
    const credential = new DefaultAzureCredential();
    const scope = "https://cognitiveservices.azure.com/.default";
    const azureADTokenProvider = getBearerTokenProvider(credential, scope);
    ```

6. 同ファイル内の 24 行目付近にある以下のコメント下のコードを

    ```JavaScript
     //Azure OpenAI クライアントの初期化 (API キーを使用した認証)
    const client = new AzureOpenAI({ endpoint, apiKey, apiVersion, deployment: deploymentName });
    ```

    以下のコードで置き換えます

    ```JavaScript
    //Azure OpenAI クライアントの初期化 (Azure マネージド ID を使用した認証)
    const client = new AzureOpenAI({ endpoint, apiKey:'',azureADTokenProvider, deployment, apiVersion });
    ```

    キーボードの \[Ctrl\] + \[S\] を押下してファイルを保存します。

7. プロジェクト内の **rag.js** ファイルを開き、ファイルの先頭にあるコメント `//[REPLACE:use_EntraID_authentication]` を以下のコードで置き換えます

    ```JavaScript
    const {
        DefaultAzureCredential,
        getBearerTokenProvider
    } = require("@azure/identity");

    // keyless authentication    
    const credential = new DefaultAzureCredential();
    const scope = "https://cognitiveservices.azure.com/.default";
    const azureADTokenProvider = getBearerTokenProvider(credential, scope);
    ```

8. 同ファイル内の 26 行目付近にある以下のコメント下のコードを

    ```JavaScript
    //埋め込みモデルのクライアントを作成 (API キーを使用した認証)
    const embeddingClient = new AzureOpenAI({ embedding_endpoint, embedding_apiKey, apiVersion, deployment: embedding_deployment });
    ```

    以下のコードで置き換えます

    ```JavaScript
    //埋め込みモデルのクライアントを作成  (Azure マネージド ID を使用した認証)
    const embeddingClient = new AzureOpenAI({ endpoint: embedding_endpoint, apiKey: '', azureADTokenProvider, deployment: embedding_deployment, apiVersion });
    ```

    続けて、ファイル内の 59 行目付近にある以下のコメント下のコードを

    ```JavaScript
     //Azure AI Search のクライアントを作成
    const searchClient = new SearchClient(search_endpoint, search_indexName, new AzureKeyCredential(search_apiKey));
    ```

    以下のコードで置き換えます

    ```JavaScript
    //Azure AI Search のクライアントを作成 (Azure マネージド ID を使用した認証)
    const searchClient = new SearchClient(search_endpoint, search_indexName, credential);
    ```

    キーボードの \[Ctrl\] + \[S\] を押下してファイルを保存します。

9. プロジェクト内の **app.js** を開き、ファイルの先頭のコードが [演習 4-1](Ex04-1.md) の作業によって以下のように変更されている場合は、

    ```JavaScript
    //Azure KeyVault を使用する場合
    let rag, lm, webSearch;
    const keyManager = require('./keymgr.js');
    (async () => {
        await keyManager.setSecretEnv();
        rag = require('./AOAI/rag.js');
        lm = require('./AOAI/lm.js');
        webSearch = require('./AOAI/webSearch.js')
    })();
    ```

    以下のコードに置き換えます

    ```JavaScript
    const rag = require('./AOAI/rag.js');
    const lm = require('./AOAI/lm.js');
    const webSearch = require('./AOAI/webSearch.js');
    ```
    キーボードの \[Ctrl\] + \[S\] を押下してファイルを保存します。

8. プロジェクト内の **.env** を開き、必要ない以下の環境変数設定を削除するか、先頭に `#` を付与してコメントアウトします

    ```.env
    #AZURE_OPENAI_API_KEY=xxxxxx
    #AZURE_SEARCH_API_KEY=xxxxxx
    ```

    [演習 4-1](Ex04-1.md) の作業で以下の環境変数を追加している場合は、同様に削除するか、先頭に `#` を付与してコメントアウトします

    ```.env
    #Azure Key Vault リソースへの接続情報
    KEY_VAULT_ENDPOINT=KeyVaultのエンドポイント
    KEY_VAULT_SECRET_LLM=handsonBot-llm-key
    KEY_VAULT_SECRET_SEARCH=handsonBot-search-key
    ```

    キーボードの \[Ctrl\] + \[S\] を押下してファイルを保存します。

