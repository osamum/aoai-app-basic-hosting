# 演習 2-6-2 : Log Analytics を使用したログの分析

Azure の監視の基盤である Azure Monitor が収集したログを分析するための機能として [Log Analytics](https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/log-analytics-overview) があります。
Log Analytics を使用して Azure Monitor が収集したログ データを並べ替え、フィルターし、分析します。 

また、より高度なクエリを作成して統計分析を実行し、結果をグラフで視覚化して特定の傾向を識別することもできます。

クエリの結果を対話的に操作する場合でも、ログ クエリ アラートやブックなどの他の Azure Monitor の機能で使用する場合でも、クエリ結果の書き込みとテストのためのツールとして Log Analytics を使用することができます。

この演習では演習用ボットアプリケーションが利用している Azure リソースに対して Log Analytics が使用できるように構成し、アプリケーションのログをクエリーしてエラーの発生状況を確認します。  

まかな手順としては、まず最初に Log Analytics ワークスペースを作成し、次に各 Azure リソースに対して Log Analytics を有効にします。そして、各リソースのログをクエリーしてエラーや監視対象イベントの発生状況を確認します。

<br>

## Log Analytics ワークスペースの作成

各 Azure リソースから Log Analytics を使用するための Log Analytics ワークスペースを作成します。Log Analytics ワークスペースは、すべての Azure および Azure 以外のリソースとアプリケーションから任意の種類のログ データを収集できるデータ ストアです。 

具体的な手順は以下のとおりです。

1. Azure ポータルのホーム画面にある検索ボックスに \[**Log Analytics**\] と入力し、検索結果の \[**Log Analytics ワークスペース**\] をクリックします

    <img src="images/LogAnalytics_Search.png" width="500px">

2. \[**Log Analytics ワークスペース**\] 画面に遷移するので、画面上部にある \[**+ 作成**\] ボタンをクリックします

    <img src="images/LogAnalytics_Create.png" width="400px">

3. \[**Log Analytics ワークスペースの作成**\] 画面に遷移し \[**基本**\] タブが表示されるので、同タブの各項目を以下のように設定します

    **プロジェクトの詳細**

    |項目|値|
    |---|---|
    |サブスクリプション \*| 現在お使いのサブスクリプション |
    |リソース グループ \*| \[**AOAI-AppEnv-handson**\] |

    **インスタンスの詳細**


    |項目|値|
    |---|---|
    |名前 \*| `AOAI-AppEnv-LogAnalytics` |
    |地域 \*| \[**Japan East**\] |

    <img src="images/LogAnalytics_Create_Detail.png" width="700px">

    設定が完了したら画面下にある \[**確認および作成**\] ボタンをクリックし、\[**作成**\] ボタンが表示されたらクリックしてデプロイを開始します。

ここまでの手順で Log Analytics ワークスペースが作成されます。


## 🌐 App Service への診断設定の追加

作成した Log Analytics ワークスペースに App Service のログを送信するための診断設定を追加します。

具体的な手順は以下のとおりです。

\[**手順**\] 

1. 演習用ボットアプリケーションをホストしている App Service の画面を開き、画面左のメニューの \[**監視**\] グループにある \[**診断設定**\] をクリックします

    \[**診断設定**\] 画面に遷移するので、画面内の \[**+ 診断設定を追加する**\] をクリックします。

    <img src="images/AppSrv_Create_DiagSetting.png" width="700px">

2.  診断設定の追加の作成画面に遷移するので、同画面の各項目を以下のように設定します

    * **診断設定の名前 \***

        `AOAI-AppEnv-DiagSetting`

    * **ログ** と **メトリック**

        すべてのチェックボックスにチェック

    * **宛先の詳細**

    |項目|値|
    |---|---|
    |Log Analytics ワークスペースへの送信| チェック |
    |サブスクリプション| お使いのサブスクリプション |
    |Log Analytics ワークスペース| \[**PaaSHandson-LogAnalytics (japaneast)**\] (※)|
    |ストレージ アカウントへのアーカイブ| 既定のまま |
    |イベント ハブへのストリーム| 既定のまま |
    |パートナー ソリューションに送信| 既定のまま |

    (※) 前の手順で作成した Log Analytics ワークスペースを選択します。

    設定が完了したら画面上部にある \[**保存**\] ボタンをクリックします。

    <img src="images/AppSrv_New_DiagSetting.png" width="700px">

    保存が完了したら、画面内右上にある \[**×**\] ボタンをクリックして画面を閉じます。

3. A画面左のメニューの \[**監視**\] グループにある \[**ログ**\] をクリックします

    \[**クエリ ハブ**\] というダイアログボックスが表示される場合は、ダイアログボックス内右上にある \[**×**\] ボタンをクリックして\[**クエリ ハブ**\] ダイアログボックスを閉じます。

    \[**ログ**\] 画面の \[**新しいクエリ 1**\] タブが表示されるので、同タブ内の \[**テーブル**\] タブのツリービュー \[**その他**\] に `AppServiceConsoleLogs` と `AppServiceHTTPLogs` が表示されていることを確認します。

    **もし表示されていない場合**は、画面上部の \[**スコープの選択**\] ボタンをクリックし、表示された Azure リソースの一覧から演習用アプリケーションをホストしている `botApp-<unique_code>` を選択し \[**適用**\] ボタンをクリックします。

    <img src="images/Azure_log_table.png" width="400px">

4.  \[**テーブル**\] タブのツリービュー \[**App Services**\] に表示されている `AppServiceHTTPLogs` を**ダブルクリック**し、画面右のクエリー エディターに文字列 `AppServiceHTTPLogs`が入力されたことを確認し、画面上部の \[**実行**\] ボタンをクリックします。

    クエリーが実行され、HTTP リクエストの一覧が表示されるので、任意のリクエストをクリックすると、そのリクエストの詳細が表示されるので確認します。

    <img src="images/AppSrv_log_queryHttpLogAllResult.png" width="1000px">

5. リクエストを HTTP500 エラーでフィルターします。

    クエリーエディターの内容を以下のように書き換え、画面上部の \[**実行**\] ボタンをクリックします。

    ```
    AppServiceHTTPLogs |
    where ScStatus == 500 
    ```
    クエリーが実行され、HTTP500 エラーのリクエストの一覧が表示されるので、任意のリクエストをクリックして **ScStatus** の内容が **500** であることを確認します。

    ![HTTP500 エラーの一覧](images/AppSrv_log_queryAllErrorResult.png)

6. HTTP500 (HTTP Server Error) をフィルターするクエリーを保存します

    画面上部の \[**保存**\] - \[**クエリとして保存**\] をクリックすると、画面の右側に \[**クエリとして保存**\] ブレードが表示されるので、同ブレードの各項目を以下のように設定します。

    |項目|値|
    |---|---|
    |クエリ名 \*| `HTTPServerError` |
    |説明 | `HTTP500 のリクエストのみをリストします` |
    |既定のクエリ パックに保存する | チェック |
    |リソースの種類 | \[**App Services**\] |
    |カテゴリ | \[**Applications**\] |
    |ラベル | \[**新しいラベルを作成**\] をクリックして `MyQuery` というラベルを作成して指定|
    
    設定が完了したら画面下にある \[**保存**\] ボタンをクリックします。

    <img src="images/AppSrv_log_querySave.png" width="300px">

7. クエリーエディタの画面に戻るので \[**クエリ**\] タブをアクティブにし、検索ボックスに `HTTPServerError` と入力してキーボードの \[Enter\] キーを押下ます

    前の手順で作成したクエリー \[**HTTPServerError**\] が検索結果に表示され、使用できることを確認します。

    <img src="images/AppSrv_log_queryFind.png" width="800px">

これでいつでも作成したクエリーを呼び出して Log Analytics で App Service のログをクエリーすることができるようになりました。

ここまでの手順では、**AppServiceHTTPLogs** のログをクエリーしましたが
同様の手順で **AppServiceConsoleLogs** のログもクエリーすることができます。

 **AppServiceConsoleLogs** ログには、アプリケーションのコンソール出力が記録されているので、アプリケーションのデバッグやトラブルシューティングに役立ちます。

![AppServiceConsoleLogsのクエリ結果](images/AppSrv_log_queryConsoleLogAllResult.png)

この演習では単純にログの一覧表示と HTTP500 エラーのフィルタリングを行いましたが、さらに複雑なクエリーを Kusto 照会言語 (KQL) で記述して、ログの検索や集計や分析等も可能です。
ログ クエリの詳しい使い方については以下のドキュメントをご参照ください。

* [**Azure Monitor でログ クエリの使用を開始する**](https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/get-started-queries)

また、今回の演習では触れませんでしたが、[演習 2-6-1 : メトリック アラートの設定](Ex02-6-1.md)で使用した**メトリック**と同様にアラート ルールを作成して、ログの内容に応じたさまざまなアクションを構成することもできます。具体的な手順については以下のドキュメントをご参照ください。

* [**チュートリアル:Azure リソースのログ クエリ アラートを作成する**](https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/tutorial-log-alert)

Log Analytics 全体の使用方法についての詳細は以下のドキュメントをご参照ください。

* [**Azure Monitor の Log Analytics の概要**](https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/log-analytics-overview)

<br>