# 演習 2-5 : 可用性設定

運用環境ではサービスの継続性（可用性）」を確保することが重要です。

負荷の増減は当然として、一時的な障害や断続的な障害が発生にも影響を最小限に抑え、必要なレベルのサービスを継続させる必要があります。これらのイベントは障害によって突発的に、メンテナンスなどによって定常的にも発生するためあらかじめ対策を講じておく必要があります。

こういった可用性を担保する対策として以下のようなものがあります。

## ✅ 可用性対策の分類と目的

| 対策カテゴリ　| 主な目的 | 具体例 |
|---|---|---|
| 障害対策 | ハードウェアやインフラの故障に備える | 可用性ゾーン、冗長構成、フェイルオーバー |
| 負荷対策 | トラフィックや処理量の増加に対応 | スケールアウト／アップ、ロードバランサー |
| 運用対策 | ヒューマンエラーやメンテナンスによる停止を、ゼロトラスト、アクセス制御 |ロールバック、ブルーグリーンデプロイ、CI/CD               
| セキュリティ対策 | 攻撃や不正アクセスによるサービス停止を防ぐ | DDoS対策

上記の表からここでは障害対策と負荷対策について基本的な以下の設定の演習を行います。

1. 可用性ゾーンの設定
2. スケールアップ/アウトの設定

<br>

## 1. 可用性ゾーンの設定

可用性ゾーンとは、同一リージョンのデータセンター内にある分離されたグループです。これは、独立した電源、冷却装置、ネットワーク インフラストラクチャがあるため、あるゾーンで障害が発生しても、リージョン サービス、容量、高可用性が残りのゾーンでサポートされます。

可用性ゾーンの利用は、[Foundry Models で Azure AI Foundry と Azure OpenAI を使用してエンタープライズ チャット アプリケーションを構築およびデプロイするのに役立つベースライン アーキテクチャ](https://learn.microsoft.com/ja-jp/azure/architecture/ai-ml/architecture/baseline-azure-ai-foundry-chat)や、 [運用環境の Azure App Service アプリケーションを設計するためのベースライン Web アプリケーションの設計](https://learn.microsoft.com/ja-jp/azure/architecture/web-apps/app-service/architectures/baseline-zone-redundant)でも推奨されています。

可用性ゾーンについての詳細については以下のドキュメントをご参照ください。

* [**Azure 可用性ゾーンとは**](https://learn.microsoft.com/ja-jp/azure/reliability/availability-zones-overview
)

可用性ゾーンは [Azure のさまざまなサービスでサポート](https://learn.microsoft.com/ja-jp/azure/reliability/availability-zones-service-support)されていますが、この演習ではデプロイしたリソース Azure App Service と Azure Storage、Azure AI Saerch の可用性ゾーンの設定を行います(※)。

(※) 公式ドキュメントで詳細な手順が提供されているものについては、手順のリンクを提供します。

### 🌐 App Service の可用性ゾーンの設定

Azure App Service の可用性ゾーンの設定は、App Service のプランの設定で行います。

Azure App Servive の可用性ゾーンは [Premium v2-4 または Isolated v2 プランの種類](https://learn.microsoft.com/ja-jp/azure/app-service/overview-hosting-plans)を使用し、プランのインスタンスが少なくとも 2 つ必要です。また、ゾーン冗長の設定は新規に App Service プランを作成する際にのみ可能です。

そのため既存の App Service で動作するアプリケーションの可用性ゾーンを有効にするには、新規に App Service プランを作成し、アプリケーションを移行する必要があります。 

この演習では西日本リージョンで選択可能(※東日本リージョンではキャパシティを超えてしまうため)な Premium v3 プランを使用して、App Service の可用性ゾーンの設定を行います。

具体的な手順は以下のとおりです。

\[**手順**\]

1. [Azure Portal](http://portal.azure.com) にログインします。

2. ポータル画面上部の \[**+**\] リソースの作成 アイコンか、表示されていない場合は画面左上のハンバーガーメニューをクリックし、\[**リソースの作成**\] をクリックします

    ![Create Resource](images/23aug_create_AzureResource.png)

3. \[**リソースの作成**\] 画面に遷移するので、検索ボックスに `App Service プラン` と入力し、表示された検索結果の \[**App Service プラン**\] のタイルをクリックします

    ![App Service プランの作成](images/AppService_tailpng.png)

4. \[**App Service プラン**\] 画面に遷移するので、\[サブスクリプション\] の内容が正しいものであることを確認したら既定のまま \[**作成**\]ボタンをクリックします

5. \[**App Service プランの作成**\] 画面が表示されるので、以下の項目を入力します

    |項目|値|
    |---|---|
    |サブスクリプション\*| (ご利用のサブスクリプション) |
    |リソース グループ\*| `AOAI-AppEnv-handson` |
    |名前\*| `az-plan-botapp` |
    |オペレーティング システム\*| `Linux` |
    |リージョン\*| \[**Japan West**\] |
    |価格プラン\*| `Premium v3 P0V3` |
    |ゾーン冗長\*| `有効` |

    ![App Service プランの作成](images/AppService_Plan_Create.png)

    設定が完了したら画面下の \[**確認および作成**\] ボタンをクリックし、内容を確認したら \[**作成**\] ボタンをクリックします。

    