# 演習 2-3-1 : Azure Storage Blob のデータ保護機能とバックアップ

Azure Storage Blob にはそれ固有のバックアップの仕組みはありません。よって、Azure Storage Blob のバックアップを取得するには Azure Backup サービスを利用する必要があります。

しかし、Azure Storage には、削除されたデータを復元したり、上書きを防いだり、上書きされたデータであっても任意のバージョンを復元することができるデータ保護機能が用意されています。

Azure Storage Blob のバックアップ方法を説明する前に、Azure Storage Blob の[データ保護機能](https://learn.microsoft.com/ja-jp/azure/storage/blobs/data-protection-overview)について説明します。

なお、この手順で使用している BLOB は、一般的なファイルを扱うのに適した **ブロック BLOB** を前提にしています。Azure Srorage Blob には、複数の種類の BLOB があり、用途に応じて使い分けることができます。BLOB の種類については以下のドキュメントを参照してください。

* [**ブロック BLOB、追加 BLOB、ページ BLOB について**](https://learn.microsoft.com/ja-jp/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs)

<br>

## Azure Storage Blob のデータ保護機能

### 論理的な削除 (ソフト デリート)

Azure Storage アカウントの論理的な削除機能を有効にしておくことで、削除された BLOB データやコンテナーを任意の期間復元することができます。

この機能は既定で有効になっており、設定内容は、Azure Storage アカウント画面の \[データ管理\] - \[**データ保護**\] から確認できます。

![Azure Storage アカウントのソフト デリート](images/Azure_Storage_softDelete.png)

論理的な削除が有効な状態で削除されたコンテナー、もしくは BLOB を復元する手順は以下のとおりです。

1. [Azure Portal](https://portal.azure.com/) にログインし、復元対象となるコンテナーもしくは BLOB が格納されている Azure Storage アカウントのリソース画面を表示します

2. 画面左のメニューから \[**コンテナー**\] をクリックし、コンテナーの一覧が表示されたたら、リスト上部の右側にある \[**アクティブなコンテナーのみを表示する**\] ドロップダウンボックスの内容を \[**アクティブな、および削除されたコンテナーを表示する**\] に変更します

3. 削除されたコンテナーがリストに表示されるので、復元したいコンテナーの右端にある \[**…**\] (その他の操作) をクリックし、表示されたメニューから \[**復元**\] をクリックします

    ![Azure Storage アカウントの削除されたコンテナー](images/Azure_Storage_restoreContainer.png)

ここまでの手順で削除されたコンテナーを復元することができました。

BLOB も同様の手順で復元することができます。

ただし、論理的な削除はあくまで削除されたデータを復元するための機能であり、上書きされたデータを復元することはできません。

この機能についての詳細は以下のドキュメントを参照してください。

* [コンテナーの論理的な削除](https://learn.microsoft.com/ja-jp/azure/storage/blobs/soft-delete-container-overview)

* [BLOB の論理的な削除](https://learn.microsoft.com/ja-jp/azure/storage/blobs/soft-delete-blob-overview)


<br>

### BLOB を任意のバージョンに復元する

Blob Storage のバージョン管理を有効にすることで上書きされた BLOB の任意のバージョンを復元することができます。

この機能は、既定では有効になっていないので、必要に応じて有効にする必要があります。この機能を有効にするには、Azure Storage アカウント画面の \[データ管理\] - \[**データ保護**\] から行うことができます。

![Azure Storage アカウントのバージョン管理](images/Azure_Storage_version.png)

Blob Storage のバージョン管理が有効な状態で、任意のバージョンの BLOB を復元する手順は以下のとおりです。

1. [Azure Portal](https://portal.azure.com/) にログインし、バージョンを戻したい BLOB が格納されているコンテナーの画面を表示します

2. BLOB (ファイル) の一覧が表示されるので、バージョンを戻したい BLOB をクリックします

3. BLOB の詳細画面が表示されるので、画面上部の \[**バージョン**\] タブをクリックします

    選択した BLOB のバージョンの一覧が表示されるので、目的のバージョンの右端にある \[**…**\] (その他の操作) をクリックし、表示されたメニューから \[**現在のバージョンに変更する**\] をクリックします

    ![Azure Storage アカウントの BLOB バージョンのリストア](images/Azure_Storage_blobVersion.png)

ここまでの手順で、BLOB の任意のバージョンを復元することができました。

この機能についての詳細は以下のドキュメントを参照してください。

* [BLOB のバージョン管理](https://learn.microsoft.com/ja-jp/azure/storage/blobs/versioning-overview)

<br>

### BLOB の上書きを防ぐ

BLOB 上書きされた際に元のバージョンに戻すのではなく、上書き自体を防ぎたい場合は、ポリシーを使用して BLOB の上書きを防ぐことができます。

詳しくは以下のドキュメントを参照してください。

* [**ビジネス クリティカルな BLOB データを書き込み 1 回、読み取り複数回 (WORM) の状態で保存する**](https://learn.microsoft.com/ja-jp/azure/storage/blobs/immutable-storage-overview)

また、ログ データのような、**常に更新されることのないデータが追加される**用途には、追加(Apend) Blob を使用することもできます。

追加 BLOB については以下のドキュメントを参照してください。

* [**追加 BLOB について**](https://learn.microsoft.com/ja-jp/rest/api/storageservices/Understanding-Block-Blobs--Append-Blobs--and-Page-Blobs#about-append-blobs)


<br>

### ポイントインタイム リストア

ポイントインタイム リストアでは、あらかじめ設定された保有期間中の BLOB データを以前の状態に復元することができます。これは、ユーザーまたはアプリケーションによって誤ってデータが削除された場合や、アプリケーション エラーによってデータが破損した場合に役立ちます。

ポイントインタイム リストアを有効にするには、ストレージ アカウントの管理ポリシーを作成し、保有期間を指定します。 保有期間中は、ブロック BLOB を現在の状態から前の時点の状態に復元できます。

この機能の有効化はAzure Storage アカウント画面の \[データ管理\] - \[**データ保護**\] から行うことができます。

実際の手順については、以下のドキュメントに記載されていますので参照してください。

* [**ポイントインタイム リストアを有効にして構成する**](https://learn.microsoft.com/ja-jp/azure/storage/blobs/point-in-time-restore-manage?tabs=portal#enable-and-configure-point-in-time-restore)

* [**アカウント内のすべてのコンテナーを復元する**](https://learn.microsoft.com/ja-jp/azure/storage/blobs/point-in-time-restore-manage?tabs=portal#restore-all-containers-in-the-account)

* [**ブロック BLOB の範囲を復元する**](https://learn.microsoft.com/ja-jp/azure/storage/blobs/point-in-time-restore-manage?tabs=portal#restore-ranges-of-block-blobs)


<br>

## Azure Backup を使用した Azure BLOB のバックアップ

ここまでの説明であったように Azure Storage Blob には、豊富なデータ保護機能が用意されており、ストレージの冗長化オプションも用意されています。

しかし、それでも Azure Backup を使って Blob データをバックアップする必要があるケース も存在します。以下にその代表的な状況を挙げます。

1. **長期保存（Long-term retention）**
   - Azure Storage のデータ保護機能は、通常、短期間のデータ保護を目的としています。長期保存が必要な場合は、Azure Backup を使用して定期的にバックアップを取得し、長期間にわたってデータを保持することができます。
2. **ランサムウェア対策・イミュータブルバックアップ**
   - Azure Backup は バックアップデータをイミュータブル（変更不可）に設定でき、悪意ある削除や改ざんから保護します。
    - ストレージのソフトデリートやバージョニングだけでは、内部からの攻撃やスクリプトによる削除に対して不十分な場合があります。
3.  **運用・監査要件への対応**
    - 金融・医療・公共などの業界では、監査証跡やバックアップの証明が求められることがあります。
    - Azure Backup は バックアップジョブのログやレポートを提供し、コンプライアンス対応を支援します。
4. **管理の一元化**
    - Azure Backup を使うことで、VM、SQL、ファイル、Blob などのバックアップを一元管理できます。これにより、運用負荷の軽減やポリシーの統一が可能になります。

この演習では、Azure Backup を使用した Azure BLOB のバックアップを実施します。

Azure Storage Blob にはそれ固有のバックアップの仕組みがないため Azure で用意されているバックアップの仕組みを利用する必要があります。

そのために[バックアップ コンテナーの作成](https://learn.microsoft.com/ja-jp/azure/backup/create-manage-backup-vault#create-a-backup-vault)、作成したバックアップ コンテナーへの[アクセス制御設定](https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-configure-manage?tabs=operational-backup#grant-permissions-to-the-backup-vault-on-storage-accounts)、[バックアップ ポリシーの作成](https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-configure-manage?tabs=operational-backup#create-a-backup-policy)などの事前準備が必要です。

ここでは一連の手順について紹介します。

### バックアップ コンテナーの作成

バックアップ コンテナーは、Azure Backup によってサポートされる特定のワークロードのバックアップ データを格納する Azure のストレージ エンティティです。

バックアップ コンテナーを使用すると、管理オーバーヘッドを最小限に抑えながら、バックアップ データを簡単に整理できます。

バックアップ コンテナーの作成手順は以下の通りです。

\[**手順**\]

1. [Azure Portal](https://portal.azure.com/) にログインし、画面上部の検索ボックスに `バックアップ コンテナー` と入力し、表示された候補から \[**バックアップ コンテナー**\] をクリックします

    ![バックアップ コンテナーの検索](images/portal_backupContainer.png)

2. \[**バックアップ コンテナー**\] の画面が表示されるので、画面上部の \[**+ 作成**\] ボタンをクリックします

    ![バックアップ コンテナーの作成ボタン](images/BackupContaner_Create.png)

3. \[**バックアップ コンテナーの作成**\] 画面が表示されるので、各項目を以下のように設定します

    | 項目 | 設定値 |
    | --- | --- |
    | **サブスクリプション** | 使用しているサブスクリプションを選択 |
    | **リソース グループ** | `AOAI-AppEnv-handson` |
    | **バックアップ コンテナー名** | `handson-backup-container` |
    | **リージョン** | \[**Japan East**\] |
    | **バックアップ ストレージの冗長性** | 任意のもの(※) |
    
    (※) この演習では `ローカル冗長` でかまいませんが、運用環境では `geo 冗長` 、もしくは `ゾーン冗長` を選択することをお勧めします。なお、この設定はバックアップ コンテナーの作成後に変更することができません。

    ![バックアップ コンテナーの作成](images/BackupContainer_Create_Settings.png)

    設定が完了したら、画面下部の \[**確認および作成**\] ボタンをクリックし、\[**作成**\] ボタンが表示されたらクリックします。

    デプロイが開始され、完了すると通知が表示されます。

ここまでの手順でバックアップ コンテナーを作成することができました。

<br>

### Azure Storage アカウントでのバックアップ コンテナーへのアクセス許可の付与

バックアップ対象となる Storage アカウントに対して、バックアップ コンテナーへのアクセス許可を付与する必要があります。

最小限のアクセス許可として `Storage Account Backup Contributor` ロールが必要です。

具体的な手順は以下の通りです。

\[**手順**\]

1. [Azure Portal](https://portal.azure.com/) にログインし、バックアップを取得する Stogare アカウントの画面を表示します

2. 画面左側のメニューで \[**アクセス制御 (IAM)**\] をクリックし、遷移した画面上部の　\[**+ 追加**\] ボタンをクリックし、表示されたメニューから \[**ロールの割り当ての追加**\] をクリックします

    ![Azure Storage アカウントのアクセス制御](images/AzureStorage_IAM_menu.png)

3. \[**ロールの割り当ての追加**\] 画面に遷移し、ロールの一覧が表示されるので、\[**Storage Account Backup Contributor**\] を選択し \[**次へ**\] ボタンをクリックします

    ![ロールの選択](images/AzureStorage_RoleAssignment.png)

4. [**メンバー**\] タブがアクティブになるので、項目 \[**アクセスの割り当て先**\] オプション ボタンで \[**マネージド ID**\] にチェックをつけ、項目 \[**メンバー**\] で \[**+ メンバーの追加**\] リンクをクリックします

5. 画面右端に \[**マネージド ID の選択**\] ブレードが表示されるので、各項目を以下のように設定します

    | 項目 | 設定値 |
    | --- | --- | 
    | サブスクリプション | 使用しているサブスクリプションを選択 |
    | マネージド ID | \[**バックアップコンテナー**\] |
    | 選択 | `handson-backup-container` |

    ![マネージド ID の選択](images/AzureStorage_Choose_ManagedID.png)

    \[**選択**\] ボタンをクリックするとブレードが閉じるので、画面下部の \[**次へ**\] ボタンをクリックします

6. \[レビューと割り当て\] タブがアクティブになるので、内容を確認し、画面下部の \[**レビューと割り当て**\] ボタンをクリックします

ここまでの手順で、バックアップ対象となる Storage アカウントに対しバックアップ コンテナーへのアクセス許可を付与することができました。  

<br>

### バックアップ ポリシーの作成

バックアップ ポリシーを作成します。

バックアップ ポリシーでは、復旧ポイントの作成のスケジュールと頻度、およびバックアップ コンテナー内の保持期間を定義します。 同じバックアップ ポリシーを使用して、1 つのバックアップ コンテナーへの複数のストレージ アカウントのバックアップを構成できます。

具体的な手順は以下の通りです。

\[**手順**\]

1. [Azure Portal](https://portal.azure.com/) にログインし、画面上部の検索ボックスに `ビジネス継続性センター` と入力し、表示された候補から \[**ビジネス継続性センター**\] をクリックします

    ![ビジネス継続性センターの検索](images/BCC_Find.png)

2. \[**ビジネス継続性センター**\] の画面が表示されるので、画面左側のメニューから \[管理\]- \[**保護ポリシー**\] をクリックします

3. \[保護ポリシー\] の画面が表示されるので、画面上部の \[**+ ポリシーの作成**\] ボタンをクリックし、表示されたメニューから \[**バックアップ ポリシーの作成**\] をクリックします

    ![保護ポリシーの追加](images/BCC_BKPolicy_menu.png)

4. \[開始 : ポリシーの作成\] 画面が表示されるので、\[コンテナーの種類\] で \[**Azure Storage Blob**\] を選択し、画面下部の \[**続行**\] ボタンをクリックします

    ![開始 : ポリシーの作成](images/BCC_BackupPolicy_start.png)

5. \[バックアップ ポリシーの作成\] 画面が表示されるので、各項目を以下のように設定します

    | 項目 | 設定値 |
    | --- | --- |
    | **ポリシー名** | `handson-backup-policy` |
    | **データソースの種類** | \[**Azure BLOB(Azure Storage)**\] |
    | **コンテナー** | \[**handson-backup-container**\](※) |

    (※) \[**コンテナーの選択**\] リンクをクリックすると、バックアップ コンテナーの一覧が表示されるので、`handson-backup-container` を選択します。

    ![バックアップ ポリシーの作成](images/BCC_BackupPolicy_select_container.png)

    設定が完了したら、画面下部の \[**次へ: スケジュールと保持期間**\] ボタンをクリックします。

6. \[**スケジュールと保持期間**\] タブがアクティブになるので、各項目の内容を任意の値に設定します。問題がなければ、既定のままでもかまいません。

    設定が完了したら、画面下部の \[**確認と作成**\] ボタンをクリックし、\[**作成**\] ボタンが表示されたらクリックします。

7. 作成が完了するのを待ち、画面右のメニューから \[管理\] - \[**バックアップ ポリシー**\] をクリックし、作成したポリシーが一覧に表示されていることを確認します

    ![バックアップ ポリシーの一覧](images/BCC_BackupPolicy_list.png)

ここまでの作業で、Azure Storage Blob 用のバックアップ ポリシーを作成することができました。
    
<br>

### Azure Storage Blob のバックアップの構成

StorageAccount_Backup_Settings.png
StorageAccount_backup_choose_container.png
StorageAccount_Backup_now.png
StorageAccount_Backup_job_status.png




<!--
https://learn.microsoft.com/ja-jp/samples/azure-samples/azure-search-dotnet-utilities/azure-search-backup-restore-index/

https://learn.microsoft.com/en-us/answers/questions/1792032/how-do-i-backup-data-of-azure-ai-search-service




https://azure.github.io/jpazpaas/2024/01/25/backup-search-service.html

-->