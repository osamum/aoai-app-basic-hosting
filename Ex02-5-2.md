# 演習 2-5-2 : スケールアップ/アウトの設定

システムが実際に稼働を開始すると、時間の経過とともに利用者が増えていき当初に見積った数よりもリクエスト数が増えてしまったり、特定の時間帯や期間にだけアクセスが集中して負荷がサーバーの処理能力を超えてしまうことがあります。このような場合、サーバーの性能を向上させるために、サーバーのスケールアップやスケールアウトを行う必要があります。

Azure 環境ではオンプレミス上のサーバーのようなハードウェアの調達やセットアップの必要はなく、Azure ポータルや CLI ツールを使用し短い時間でスケールアップやスケールアウトの環境を構築することができます。

このタスクでは、Azure App Service でのスケールアップ、スケールアウト、自動スケーリングの設定方法について確認します。

<br>

## スケールアップ

サービスのスケールアップとは、文字通りサーバーの処理能力（スケール）を垂直方向に向上させる方法です。具体的には CPU、メモリ、ディスク領域を増やしたり、さまざまな専用のオプション機能を選択可能になります。

ただし、スケールアップにはサービスのダウンタイムが発生する可能性があるため、注意が必要です。スケールアップは、サーバーの性能を向上させるための最も簡単な方法ですが、物理的な制約により限界があります。

Azure のリソースのスケールアップは物理的なハードウェアの変更を伴わないため、Azure ポータルや CLI ツールを使用してプランを変更するだけで簡単に行うことができます。

### 🌐 App Service のスケールアップ

App Service のスケールアップは、Azure ポータルを使用したスケールアップの手順を確認しますが、メニューからプランを選択するだけなので、実際に操作は行わず UI を確認するだけで終了とします。

具体的な手順については、以下の公式ドキュメントの内容に従い作業を行ってください。

* [**Azure App Service でアプリをスケールアップする - 価格レベルのスケールアップ**](https://learn.microsoft.com/ja-jp/azure/app-service/manage-scale-up#scale-up-your-pricing-tier)

### 🛢️ Storage アカウントのスケールアップ

Azure Storage アカウントのスケールアップは、ストレージ アカウントのパフォーマンスを向上させるために、ストレージ アカウントの種類を変更することを指します。Azure Storage では、Standard と Premium の 2 つのストレージ アカウントの種類があり、Premium ストレージ アカウントは高いパフォーマンスを提供します。

既存の Standard ストレージ アカウントを Premium ストレージ アカウントに変更することはできません。新しい Premium ストレージ アカウントを作成し、データを移行する必要があります。ただし、Azure サポートに問い合わせることで、Standard ストレージ アカウントのまま高い容量とイングレスの制限を要求することもできます。

詳しくは以下のドキュメントをご参照ください。

* Standard Storage アカウントのスケーラビリティとパフォーマンスのターゲット - [**Standard Storage アカウントのスケール ターゲット**](https://learn.microsoft.com/ja-jp/azure/storage/common/scalability-targets-standard-account?toc=%2Fazure%2Fstorage%2Fblobs%2Ftoc.json&bc=%2Fazure%2Fstorage%2Fblobs%2Fbreadcrumb%2Ftoc.json#scale-targets-for-standard-storage-accounts)

### 🔍 AI Search のスケールアップ

Azure AI Search では、パーティション数とレプリカ数を増やすことでスケールアップを行います。これにより、以下のような効果が得られます：

* パーティション数の増加：より多くのデータを格納可能に
* レプリカ数の増加：クエリのスループット向上と高可用性の確保

この設定は、演習 [AI Search の可用性ゾーンの設定](Ex02-5-1.md#-ai-search-%E3%81%AE%E5%8F%AF%E7%94%A8%E6%80%A7%E3%82%BE%E3%83%BC%E3%83%B3%E3%81%AE%E8%A8%AD%E5%AE%9A) で確認した Azure ポータルの AI Search 画面 \[設定\] - \[**スケーリング**\] メニューで行えます。また、同画面内の \[**価格レベルの変更**\] をクリックして、より大きい値を指定可能な価格レベルに変更することもできます。 

その他の詳細は以下のドキュメントをご参照ください。

* [**Azure AI Search のサービス レベルを選択する**](https://learn.microsoft.com/ja-jp/azure/search/search-sku-tier#partition-size-and-speed)

<br>

## スケールアウト

スケールアップがサーバーの CPU やメモリといったものを増強して性能を垂直方向に向上させる方法であるのに対し、スケールアウトはサーバー単体の能力はそのままに、処理を複数台のサーバーに分散し処理能力（スケール）を水平方向に向上させる方法です。

この演習でデプロイされた App Service、Storege アカウント、AI Search ではそれぞれ仕組みや設定が異なります。


### 🌐 App Service のスケールアウト (手動)

Azure App Service では、スケールアウトは App Service プランのインスタンス数を増やすことで行います。App Service プランのインスタンス数を増やすことで、アプリケーションの負荷が増えたときに、負荷を分散することができます。

App Service をスケールアウトする方法は、スケールアップ同様、Azure ポータル、Azure CLI、Azure PowerShell、REST API、または Azure Resource Manager テンプレートを使用して行うことができます。

このタスクの演習では、Azure ポータルを使用した手動スケールアウトの手順を確認します。

Azure App Service で、Azure ポータルから手動スケールアップを行う手順は以下のとおりです。


1. [Azure ポータル](https://portal.azure.com/)にログインし、演習で使用している App Service を選択します

2. 画面左のメニューから \[**スケール アウト (App Service プラン)**\] を選択します

3. 遷移した画面で \[スケールアウト方法\] で \[**手動*\] を選択し、\[**インスタンス数**\] スライド コントロールで任意の数を選択し、\[**保存**\] ボタンをクリックすることでスケールアウト用のインスタンス数を変更できます 

    <img src="images/AppSrv_ScaleUp_manual.png" width="1000px">

4. 画面左のメニューバーから \[**App Service プラン**\] をクリックし、遷移した画面で \[**Instance count**\] 選択すると、前の手順で指定した数にインスタンス数が変更されていることが確認できます 

    <img src="images/AppSrv_Scaleout_count.png" width="700px">

    これで App Service の手動スケールアウトの手順は完了です。

この方法を使用することで任意のタイミングでスケール アウトを行うことができます。

<br>

### 🌐 App Service のスケールアウト (自動)

 App Service では負荷が増えたときに自動的にインスタンス数を増やす自動スケーリングの設定も可能です。

自動スケーリングを使用すると、負荷が増えたときにインスタンス数を増やし、負荷が減ったときにインスタンス数を減らすことができます。これにより、負荷に応じてインスタンス数を自動的に増減させることができます。

自動スケーリングの設定は、Azure ポータル、Azure CLI、Azure PowerShell、REST API、または Azure Resource Manager テンプレートを使用して行うことができます。

このタスクの演習では、Azure ポータルを使用した自動スケーリングの手順を実施します。
具体的な設定手順は以下のとおりです。

1. [Azure ポータル](https://portal.azure.com/)のホーム画面、左上にあるハンバーガーメニューをクリックし、表示されたメニューから \[**監視**\] を選択します

    <img src="images/Menu_Azure_Monitor.png" width="500px">

2. \[**モニター**\] 画面に遷移するので画面左のメニューから \[**自動スケーリング**\] を選択します。

    自動スケーリングが適用できるすべてのリソースが表示されるので、演習用アプリケーションをホストしている App Service のプランの名前をクリックします


    <img src="images/AppSrv_AutoScaling_Choseplan.png" width="700px">

3. \[**自動スケーリング設定**\] の画面に遷移するので、画面内の \[**カスタム自動スケーリング**\] (図中 ①) をクリックし、表示された \[**既定** \*  自動生成された既定のスケール条件\] 内の項目 \[スケールモード\] でオプション ボタン \[**メトリックに基づいてスケーリングする**\] (図中 ➁)を選択し、さらに \[ルール\] の説明文中のリンク <u>**規則を追加する**</u>(図中 ➁)をクリックします。

    <img src="images/AppSrv_AutoScale_Settings.png" width="1000px">

4. 画面右に \[**スケール ルール**\] ブレードが表示されます

    このブレードではスケール アウトする条件を設定しますが、この演習ではなるべく早くスケールアウトの動作を確認したいので、CPU の使用率が 20% を超えたらスケールアウトするよう、ブレード内の項目 [**スケール操作をトリガーするメトリックのしきい値** \*] を `20` に変更します。なお、それ以外の項目はの設定は全て既定のままです。
  
    <img src="images/AppSrv_Scaleout_rule.png" width="500px">

    設定が完了したら \[追加\] ボタンをクリックします。

5. \[**自動スケーリング設定**\] の画面に戻るので画面下部の \[**インスタンスの制限**\] で \[**最大値 \***\] の値を `3` に変更します。

    <img src="images/AppSrv_AutoScale_instance_maxValue.png">

    画面右上の \[**保存**\] ボタンをクリックします。

    
ここまでの手順で自動スケーリングの設定は完了です。

なお、今回の手順では CPU の使用率が上がった際にインスタンスを増やす設定しか行っていないため、一度スケールアウトが発生すると、CPU の使用率が下がってもインスタンス数は減らないままになってしまいます。

このような場合、インスタンス数を減らす(スケールイン)ための設定を行う必要がありますが、この演習では時間の都合上割愛しています。

スケールインの設定手順については、以下のドキュメントに詳しい手順が載っていますのでぜひご参照ください。

* [**Azure での自動スケールの使用 - 最初の自動スケーリング設定を作成する**](https://learn.microsoft.com/ja-jp/azure/azure-monitor/autoscale/autoscale-get-started?toc=%2Fazure%2Fapp-service%2Ftoc.json#create-your-first-autoscale-setting)


次の手順では Azure Load Testing を使用して負荷をかけ、自動スケーリングが正しく動作するか確認します。