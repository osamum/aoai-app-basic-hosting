# 演習 6-2 : セキュリティ設定の追加

 Application Gateway について、ベースラインアーキテクチャで推奨されているセキュリティ設定を追加します。

 この演習では、以下の作業を行います。


 1. Web Application Firewall ポリシーの作成と適用
 2. DDoS 保護プランの設定
      
<br>

 ## 1. Web Application Firewall ポリシーの作成と適用

 [Web Application Firewall](https://learn.microsoft.com/ja-jp/azure/web-application-firewall/overview) は、一般的な悪用や脆弱性から Web アプリケーションを一元的に保護するための機能です。Application Gateway に WAF ポリシーを適用することで、Open Web Application Security Project (OWASP) コア ルール セットに基づいて、SQL インジェクションやクロスサイト スクリプティングなどの一般的な攻撃からアプリケーションを保護できます。
 
 この機能は、Web Application Firewall 単体ではデプロイできず、以下のいずれかのサービスに関連付けて使用します。

* [Application Gateway](https://learn.microsoft.com/ja-jp/azure/web-application-firewall/ag/ag-overview)
* [Azure Front Door](https://learn.microsoft.com/ja-jp/azure/web-application-firewall/afds/afds-overview)
* [Azure Content Delivery Network (CDN)](https://learn.microsoft.com/ja-jp/azure/web-application-firewall/cdn/cdn-overview)
  
この作業では、Application Gateway に関連付ける WAF ポリシーを作成し、Application Gateway に適用します。

具体的な手順は以下の通りです。

\[**手順**\]

1.  Application Gateway に WAF ポリシーを適用可能にするために、対象となる Application Gateway のレベルを **WAF V2** に変更する必要があります。

    Azure ポータルで、このハンズオンで作成した Application Gateway `handson-AG` の設定画面を開きます。

2. 画面左側のメニューで、\[設定\] - \[**構成**\] を選択し、遷移した画面の \[**レベル**\] ドロップダウンボックスで \[**WAF_v2**\] を選択します。

   画面左上の \[保存\] ボタンをクリックし、レベル変更を保存します。

    ![Application Gateway のレベル変更](images/AG_change_lebel.png)

3. Azure ポータル画面上部の検索ボックスに `WAF ポリシー` と入力し、表示された検索結果から \[**Web Application Firewall ポリシー (WAF)**\] を選択します

    ![WAF ポリシーメニューの検索](images/WAF_Search.png)

4. \[**ネットワーク セキュリティ | Web アプリケーション ファイヤーウォール**\] 画面で、画面上部の \[+ 作成\] ボタンをクリックします

    ![WAF ポリシーの作成の開始](images/WAF_Create_menu.png)

5. \[**Web アプリケーション ファイアウォール ポリシーの作成**\] 画面で、以下の項目を設定します

    **プロジェクトの詳細**

    | 項目 | 設定値 |
    |---|---|
    | 次に対するポリシー: \* | \[**リージョンの WAF (Application Gateway)**\] にチェック|
    | サブスクリプション | *このハンズオンで使用しているサブスクリプション* |
    | リソース グループ | \[**AOAI-AppEnv-handson**\] |

    **インスタンスの詳細**

    | 項目 | 設定値 |
    |---|---|
    | 名前: \* | `handson-WAF-AG` |
    | 場所: \* | \[**(Asia Pacific) Japan East**\] |
    | ポリシーを有効にする: \* | \[**有効**\] にチェック |
    | ポリシー モード: \* | \[**検出**\] にチェック |

    ![WAF ポリシーの作成](images/WAF_create_plicy.png)

    設定が完了したら、画面下部の \[次へ\] ボタンをクリックします。

6. \[**マネージドルール**\] タブ画面に遷移するので、適用されるルール セットを確認します

    (※確認のみでとくに作業は不要です)

    ![WAF ポリシー マネージドルールの設定](images/WAF_Policy_managedRule.png)

    今回は \[カスタム ルール\] は設定しないので、画面上部の \[**関連付け**\] タブをクリックします。

7. \[**関連付け**\] タブ画面に遷移するので、\[**+ 関連付けの追加**\] ボタンをクリックし、表示されたドロップダウンメニューから \[**Application Gateway**\] を選択します

8. 画面右に \[**アプリケーションゲートウェイを関連付け...**\] ブレードが表示されるので、以下の項目を設定します
    | 項目 | 設定値 |
    |---|---|
    | Application Gateway (WAF v2 SKU) | \[**handson-AG**\] |
    | 現在の構成と異なる場合でも Web Application Firewall ポリシーの構成を適用する | \[**チェック**\] |

    各項目を設定したら同ブレード下部の \[**追加**\] ボタンをクリックし、\[**関連付け**\] タブ画面下部の \[**確認および作成**\] ボタンをクリックします。

    ![WAF ポリシー 関連付けの追加](images/WAF_Association_add.png)

    ここまでの手順で、WAF ポリシーを作成し、Application Gateway に関連付けを行うことができました。

9. この演習で作成した Application Gateway `handson-AG` で、Web Application Firewall のメトリック アラートと、診断設定が有効になっていることを確認します。

    Azure ポータルで、Application Gateway `handson-AG` の設定画面を開き、画面左側のメニューで \[監視\] - \[**メトリック**\] を選択します。
    
    メトリック チャート上にあるボックスの \[**メトリック**\] ドロップダウン ボックスをクリックし、表示されたメトリック一覧の中に **WAF** というプレフィックスが付いたメトリックが存在することを確認します。
 
    ![Application Gateway での WAF メトリックの確認](images/AG-WAF-Metric.png)

    各メトリックの詳細については、以下の記事を参照し、適宜メトリック アラートを設定してください。(※メトリック名まで日本語に翻訳されているので注意してください)

    * [**Application Gateway WAF v2 のメトリック**](https://learn.microsoft.com/ja-jp/azure/web-application-firewall/ag/application-gateway-waf-metrics#application-gateway-waf-v2-metrics)

10. 同 Application Gateway の診断設定で、**Web Application Firewall** とその他の診断設定を追加します

    画面左側のメニューから \[監視\] - \[**診断設定**\] を選択し、遷移した画面で \[**+ 診断設定を追加する**\] ボタンをクリックします。

    ![Application Gateway での診断設定の追加の開始](images/AG-add-Diag.png)

11. \[**診断設定**\] 画面に遷移するので、\[ログ\] の \[カテゴリ\] に、**Web Application Firewall Log** が存在することを確認し、画面の各項目を以下のように設定します

    | 項目 | 設定値 |
    |---|---|
    | 診断設定の名前: \* | `AOAI-AG-DiagSetting` |
    

    **ログ** 
    
    **all logs** にチェック(※以下の3項目すべてにチェックが入ります)

    * ApplicationGatewayAccessLog
    * ApplicationGatewayPerformanceLog
    * ApplicationGatewayFirewallLog

    **宛先の詳細**

    | 項目 | 設定値 |
    |---|---|
    | **Log Analytics ワークスペース** | \[**チェック**\] |
    | サブスクリプション | *このハンズオンで使用しているサブスクリプション* |
    | ワークスペース | \[**AOAI-LogAnalytics**\] |
    |ターゲット テーブル|*既定のまま*| 

    ![Application Gateway での診断設定の追加](images/AG-add-DiagSetting.png)

    各項目を設定したら画面上部の \[**保存**\] ボタンをクリックし、診断設定を保存します。

    ここまでの作業で、Application Gateway に WAF を含む診断設定を追加することができました。

    Application Gateway の診断ログの分析方法については、以下の記事の内容を参考に行ってください。

    * [**Log Analytics を使用して Application Gateway Web アプリケーション ファイアウォール (WAF) のログを調べる**](https://learn.microsoft.com/ja-jp/azure/web-application-firewall/ag/log-analytics?source=recommendations)

この作業では、Web Application Firewall (WAF) ポリシーを作成し、Application Gateway に適用しました。

これにより、Application Gateway では WAF のメトリックを検出できるようになり、WAF ログを Log Analytics ワークスペースに送信できるようになりました。

Azure Application Gateway での Azure Web Application Firewall (WAF) のベスト プラクティスについては、以下の記事を参照してください。

* [**Azure Application Gateway での Azure Web Application Firewall (WAF) のベスト プラクティス**](https://learn.microsoft.com/ja-jp/azure/web-application-firewall/ag/best-practices)

<br>

## 2. DDoS 保護プランの設定

Azure DDoS Protection は、Azure Virtual Network 内のリソースを分散型サービス拒否 (DDoS) 攻撃から保護するためのサービスです。

Azure DDoS Protection は、レイヤー 3 とレイヤー 4 のネットワーク レイヤーで保護されますが、Web Application Firewall (WAF) と組み合わせることで、[レイヤー 7 のアプリケーション レイヤーでの保護](https://learn.microsoft.com/ja-jp/azure/web-application-firewall/shared/application-ddos-protection#azure-waf-with-azure-application-gateway)も提供します。

Application Gateway WAF SKU を使用すると、多くの L7 DDoS 攻撃を軽減できます。

![DDoS 保護プランの検索](images/DDoS_Search.png)

![DDoS 保護プランの作成の開始](images/DDoS_menu_create.png)

![DDoS 保護プランの作成](images/DDoS_create_Plan.png)

![仮想ネットワークへの DDoS 保護プランの関連付け](images/vnet-jpeast-apply-DDosProtection.png)


![パブリックIPアドレスへのDDoS保護プランの適用](images/pip-apply-DDosProtection.png)

![](images/PIP-add-diag.png)


https://learn.microsoft.com/ja-jp/azure/ddos-protection/ddos-protection-features#metric-for-an-ip-address-under-ddos-attack