# 演習 2-6 : 高度なログ監視

[演習 2-2 : App Service ログの設定と有効化](Ex02-2.md)では、一般的な Web サーバーで取得可能なログを Azure App Service で取得する手順について紹介しましたが、Azure 環境では監視ソリューションである [Azure Monitor](https://learn.microsoft.com/ja-jp/azure/azure-monitor/fundamentals/overview) やログ分析ソリューションである [Azure Log Analytics](https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/log-analytics-overview) の機能を使用して複数のサービスの実行状況を監視するためのログを取得することができます。

このタスクでは、[メトリック](https://learn.microsoft.com/ja-jp/azure/app-service/web-sites-monitor#understand-metrics)を使用した状態の監視と Log Analytics を使用して Azure Monitor が取得したログをクエリーし、必要な情報を取得する方法、また、[Application Insights](https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/app-insights-overview) の[自動インストルメンテーション](https://learn.microsoft.com/ja-jp/azure/azure-monitor/app/codeless-overview)のアプリケーション監視の機能について確認します。

**👁️ Azure の監視ソリューションについて**

この演習で使用する メトリック、Log Analytics、Application Insights はいずれも Azure Monitor の機能です。Azure Monitor はクラウド環境、オンプレミス環境問わず監視データを収集し、分析し、それに対応するための包括的な監視ソリューションであり、Azure におけるアプリケーションを監視するサービスの基盤となっています。Azure Monitor は、アプリケーションのパフォーマンスを把握し、アプリケーションに影響を与える問題と、アプリケーションが依存するリソースを事前に特定するのに役立ちます。

その他の監視ソリューションとして [**Azure Service Health**](https://learn.microsoft.com/ja-jp/azure/service-health/overview) があります。
Azure Service Health は、停止や計画メンテナンスなどの Azure サービスの問題が影響を受けた場合に、常に情報を入手し、アクションを実行するのに役立ちます。つまり、ホストしているアプリケーションではなく、Azure サービスそのものに対しての監視を行うことができます。


この 2 つの監視サービスの役割と違いについての詳細は以下のドキュメントをご参照ください。

* [**What’s the difference between Azure Monitor and Azure Service Health?**](https://azure.microsoft.com/en-us/blog/what-s-the-difference-between-azure-monitor-and-azure-service-health/)

**📈 メトリックとログについて**

Azure Monitor の**メトリック**と**ログ**は、システムの監視に使用される 2 つの主要なデータタイプですが、それぞれ異なる目的と特性を持っています。

**メトリック**は、数値で表されるパフォーマンスデータ（例えば、CPU使用率やメモリ使用量など）を時系列データベースに収集する機能で、一定の間隔で収集されます。これらのデータは、システムの特定の時点での状態を示し、グラフを表示して確認することができます⁵。

一方、**ログ**は、システム内で発生するあらゆるイベントを記録したもので、詳細な説明のテキストが付加されます。ログは、特定のイベントや問題についてより詳細な情報を提供し、複雑な分析に適しています。また、ログは定期的には収集されず、データの構造もメトリックとは異なります。

したがって、メトリックはシステムの全体的なパフォーマンスを把握するために使用され、ログは特定の問題やイベントを詳細に分析するために使用されます。また、メトリックとログはそれぞれ異なるデータソースから収集され、異なる方法で分析されます。

Azure Monitor が提供するメトリックとログについての詳細はそれぞれ以下のドキュメントをご参照ください。

* [**Azure Monitor のメトリックの概要**](https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/data-platform-metrics)

* [**Azure Monitor のログの概要**](https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/data-platform-logs)

<br>

## メトリック アラートの設定

メトリックはパフォーマンスデータを数値化して監視できますが、メトリックの値が特定の閾値を超えた場合にアラートを発行することもできます。

たとえば使用しているリソースの CPU やメモリの使用率が想定以上に高くなった場合にアラートを発行して管理者に対応を促したり、障害を検知し、修復のためのアクションを自動的に実行することもできます。

また HTTP のステータスも監視できるので、これを使用してエラーが発生した際にアラートを発行することもできます。

### App Service でのメトリック アラートの設定


この演習では演習用ボットアプリケーションをホストしている App Service に対し、HTTP500 エラーが発生した際にアラートを発行する設定を行います。

具体的な手順は以下のとおりです。

\[**手順**\]

1. [Azure ポータル](http://portal.azure.com) にログインし、演習で使用している App Service のリソース画面を表示します

2. 画面左側のメニューで \[**概要**\] が選択されていることを確認し、画面内の \[**既定のドメイン**\] の URL をクリックします

3. 新しいタブで演習用アプリケーションが表示されるので、Web ブラウザーのナビゲーションバーの URL を以下のように書き換えます

    ```
    https://<app-name>.azurewebsites.net/error
    ```

    (※) ここで、\<app-name\> は演習で使用している App Service の名前に置き換えてください

    この URL にアクセスすると、HTTP500 エラーが発生するので、メトリックやログで分かりやすいように、この操作を時間の間隔を少しあけて複数回行ってください。

    ![HTTP500 エラーの発生](images/AppSrv_HTTP500.png)

3.  画面左のメニューから項目 \[**監視**\] の下にある \[**メトリック**\]を選択し、遷移した画面で検出条件の各ドロップダウン ボックスを以下のように設定します

    |項目|値|
    |---|---|
    |スコープ| `MovieApp-XYZ` |
    |メトリック名前空間| `スロット 標準的なメトリック` |
    |メトリック| `HTTP Server Errors` |

    <img src="images/AppSrv_Metric.png" width="800px"> 

    設定と同時に前の手順にで発生された HTTP500 エラーの合計数グラフに表示されることを確認します。また各グラフのスパイク位置をクリックすると、その回数が表示されます。

    <img src="images/AppSrv_Metric_httpError_Summary.png" width="700px">

4. HTTP Server Error 発生時にアラート メッセージが送信されるように設定します。
    グラフ上部の \[**新しいアラート ルール**\] をクリックします

    ![新しいアラートルールの作成](images/AppSrv_NewAleartRoule_menu.png)

6. \[**アラート ルールの作成**\] 画面に遷移するので、\[**条件**\] タブの各項目を以下のように設定します

    |項目|値|
    |---|---|
    |シグナル名 \*| \[**Http Server Errors**\] |

    **アラート ロジック**

    |項目|値|
    |---|---|
    |しきい値| \[**Static**\] |
    |集計の種類| \[**最大値**\] |
    |演算子| \[**次の値より大きい**\] |
    |単位| \[**カウント**\] |
    |しきい値 \*| `3` | 

    **ディメンジョンで分割する**

    (既定のまま)

    **評価するタイミング**

    |項目|値|
    |---|---|
    |確認する間隔| \[**1 分**\] (※)|
    |ルックバック期間| \[**5 分**\] |

    (※) 演習では早めに結果を確認したいため最小時間に設定してあります。

    設定が完了したら画面下にある \[**次へ: アクション**\] ボタンをクリックします
 
    <img src="images/AppSrv_Create_aleartRule.png" width="700px">

 7. \[**アクション**\] タブに遷移するので、\[**クイック アクションの使用 (プレビュー)　1 つ以上のクイック操作を選択します。**\] オプション ボタンをクリックし、画面右に表示された \[**クイック アクションの使用 (プレビュー)**\] ブレードの各設定を以下のように設定し、\[**保存**\] ボタンをクリックします

    |項目|値|
    |---|---|
    |アクション グループ名 \*| `Alert_HttpServer_Error` |
    |表示名 \*| `BotWebAppErr` |
    |アクション| \[**メール**\] にチェック|

    ![クイック アクションの使用](images/AppSrv_create_quickAction.png)

    ブレードが閉じ、\[**アラート ルールの作成**\] 画面に戻ったら \[**次へ : 詳細 \>**\] ボタンをクリックします

8. \[**詳細**\] タブに遷移するので、同画面の各項目を以下のように設定します

    **プロジェクトの詳細**

    |項目|値|
    |---|---|
    |サブスクリプション \*| 現在お使いのサブスクリプション |
    |リソース グループ \*| \[**AOAI-AppEnv-handson**\] |

    **アラート ルールの詳細**

    |項目|値|
    |---|---|
    |重大度 \*| \[**1 - エラー**\] |
    |アラート ルール名 \*| `HttpServerError_Notice` |
    |アラート ルールの説明| `アプリケーションのサーバーサイドでエラーが発生した際に通知します` |

    <img src="images/Alert_Create_Detail.png" width="700px">

    設定が完了したら \[**確認および作成**\] ボタンをクリックし、\[**作成**\] ボタンが表示されたらクリックします

    アラートルールの作成が完了するまで待ちます

9. アラートルールの作成が完了したら、演習用アプリケーションにアクセスして HTTP500 エラーを 3 回以上発生させます

    ```
    https://<app-name>.azurewebsites.net/error
    ```

    (※) ここで、\<app-name\> は演習で使用している App Service の名前に置き換えてください

    しばらくすると、アラート ルールの \[**通知**\] タブで設定したメールアドレスにアラートメールが届くので内容を確認してください。

    <img src="images/Alert_email.png" width="500px">

10. メール内の \[**View the alert in Azure Monitor \>**\] ボタンをクリックすると、Web ブラウザーで \[**メトリクス アラートの詳細**\] 画面が表示されることを確認します

    ![アラートの詳細](images/Detail_MetricAleart.png)

    ここでは、アラートの状態や発生した時間、アクションの履歴などを確認することができます。

    同様にメール内の \[**Investigate \>**\] ボタンをクリックすると、Web ブラウザーで \[**Application Insights**\] 画面が表示されますが、ここまでの手順では Application Insights は設定していないため、アプリケーションの詳細な情報は表示されません。

ここまでの手順でアラートメッセージの設定作業は完了です。

この演習では Azure Monitor のメトリックの機能を使用して App Service でホストするアプリケーションのサーバーサイドのエラー (HTTP500.x)を監視し、エラーが発生した際にメールを送信するアラート ルールを作成しました。

メトリックでは HTTP のステータス以外でも CPU 使用率やメモリ使用量などのパフォーマンスデータ、そのた監視対象が提供するさまざまなデータを監視することができます。

また、今回の手順ではアラートルールの作成で \[クイック アクション\] を使用してメールでの通知のみを設定しましたが、アクション グループを作成するか、もしくは今回作成したアクショングループに新規にアラートルールを追加してさまざまな通知の種類、アクション タイプを設定することもできます。

<img src="images/ActionGroup_Edit.png" width="700px">

よって、たとえば事前に障害が発生する兆候と回避方法を把握している場合にはメトリックで検知し、**アクション**から Webhook や Function でそれを回避するためのアクションを実行することもできます。

同様にもし、障害が発生した場合でも、修復方法がわかっている場合は障害を検知し**アクション**を使用して自動回復する仕組みを用意しておくこともできます。

その他、この演習ではメトリックを異常検知のトリガーとしてしか使用しませんでしたが、App Service の \[**メトリック**\] メニューを選択した際に表示されるメトリック エクスプローラーでは複数のデータソースを組み合わせたり、グラフの種類を変更したりすることで、より詳細な監視を行うことができます。

詳細については以下のドキュメントをご参照ください。　

* [**Azure Monitor メトリックス エクスプローラーを使用してメトリックを分析する**](https://learn.microsoft.com/ja-jp/azure/azure-monitor/essentials/analyze-metrics)

App Service で使用できるメトリックについては以下のドキュメントをご参照ください。

* [**Azure App Service のアプリの監視 - メトリックを理解する**](https://learn.microsoft.com/ja-jp/azure/app-service/web-sites-monitor#understand-metrics)

<br>

### OpenAI Service でのメトリック アラートの設定






## Azure OpenAI サービス監視メトリック一覧

| カテゴリ       | メトリック名                          | 説明                                                                 | 対象モデル                         |
|----------------|----------------------------------------|----------------------------------------------------------------------|------------------------------------|
| リクエスト     | AzureOpenAIRequests                    | API 呼び出し回数（ステータスコード別に分割可能）                    | 全モデル                           |
| 可用性         | AzureOpenAIAvailabilityRate            | 可用性率（成功リクエストの割合）                                    | 全モデル                           |
| レイテンシ     | AzureOpenAITimeToResponse              | 最初の応答までの時間                                                 | 全モデル                           |
|                | AzureOpenAITTLTInMS                    | 最後のバイトが返るまでの時間                                        | 全モデル                           |
|                | AzureOpenAINormalizedTTFTInMS          | 最初のバイトが返るまでの時間（正規化）                              | 全モデル                           |
|                | AzureOpenAITokenPerSecond              | トークン生成速度                                                     | 全モデル                           |
| 使用量         | ProcessedPromptTokens                  | 入力トークン数                                                       | 全モデル                           |
|                | GeneratedTokens                        | 出力トークン数                                                       | 全モデル                           |
|                | TokenTransaction                       | 入力＋出力トークンの合計                                             | 全モデル                           |
|                | ActiveTokens                           | キャッシュされていないトークン数（PTU 利用時）                       | 全モデル                           |
| 安全性         | RAIHarmfulRequests                     | 有害と判定されたリクエスト数                                         | 全モデル                           |
|                | RAIRejectedRequests                    | コンテンツフィルターにより拒否されたリクエスト数                    | 全モデル                           |
|                | RAITotalRequests                       | 安全性チェック対象となったリクエスト数                               | 全モデル                           |
| DALL·E 3       | ContentSafetyImageAnalyzeRequestCount  | 画像モデレーション呼び出し回数                                      | DALL·E 3                           |

## 推奨アラート例

| 条件                                 | 意味・目的                         |
|--------------------------------------|------------------------------------|
| AzureOpenAIAvailabilityRate < 99%    | サービス障害の可能性               |
| AzureOpenAITimeToResponse > 2000ms   | レイテンシ異常                     |
| RAIHarmfulRequests 増加傾向          | セキュリティリスクの兆候           |
| AzureOpenAIRequests 急増             | スパイク検知、コスト管理           |
