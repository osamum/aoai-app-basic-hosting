# 2. Azure Storage Blob のデータ保護機能とバックアップ

Azure Storage Blob にはそれ固有のバックアップの仕組みありません。よって、Azure Storage Blob のバックアップを取得するには Azure Backup サービスを利用する必要があります。

しかし、Azure Storage には、削除されたデータを復元したり、上書きを防いだり、上書きされたデータであっても任意のバージョンを復元することができるデータ保護機能が用意されています。

Azure Storage Blob のバックアップ方法を説明する前に、Azure Storage Blob の[データ保護機能](https://learn.microsoft.com/ja-jp/azure/storage/blobs/data-protection-overview)について説明します。

<br>

### 論理的な削除 (ソフト デリート)

Azure Storage アカウントの論理的な削除機能を有効にしておくことで、削除された BLOB データやコンテナーを任意の期間復元することができます。

この機能は既定で有効になっており、設定内容は、Azure Storage アカウント画面の \[データ管理\] - \[**データ保護**\] から確認できます。

![Azure Storage アカウントのソフト デリート](images/Azure_Storage_softDelete.png)

論理的な削除が有効な状態で削除されたコンテナー、もしくは BLOB を復元する手順は以下のとおりです。

1. [Azure Portal](https://portal.azure.com/) にログインし、復元対象となるコンテナーもしくは BLOB が格納されている Azure Storage アカウントのリソース画面を表示します

2. 画面左のメニューから \[**コンテナー**\] をクリックし、コンテナーの一覧が表示されたたら、リスト上部の右側にある \[**アクティブなコンテナーのみを表示する**\] ドロップダウンボックスの内容を \[**アクティブな、および削除されたコンテナーを表示する**\] に変更します

3. 削除されたコンテナーがリストに表示されるので、復元したいコンテナーの右端にある \[**…**\] (その他の操作) をクリックし、表示されたメニューから \[**復元**\] をクリックします

    ![Azure Storage アカウントの削除されたコンテナー](images/Azure_Storage_restoreContainer.png)

ここまでの手順で削除されたコンテナーを復元することができました。

BLOB も同様の手順で復元することができます。

ただし、論理的な削除はあくまで削除されたデータを復元するための機能であり、上書きされたデータを復元することはできません。

この機能についての詳細は以下のドキュメントを参照してください。

* [コンテナーの論理的な削除](https://learn.microsoft.com/ja-jp/azure/storage/blobs/soft-delete-container-overview)

* [BLOB の論理的な削除](https://learn.microsoft.com/ja-jp/azure/storage/blobs/soft-delete-blob-overview)


<br>

### BLOB を任意のバージョンに復元する

Blob Storage のバージョン管理を有効にすることで上書きされた BLOB の任意のバージョンを復元することができます。

この機能は、既定では有効になっていないので、必要に応じて有効にする必要があります。この機能を有効にするには、Azure Storage アカウント画面の \[データ管理\] - \[**データ保護**\] から行うことができます。

![Azure Storage アカウントのバージョン管理](images/Azure_Storage_version.png)

Blob Storage のバージョン管理が有効な状態で、任意のバージョンの BLOB を復元する手順は以下のとおりです。

1. [Azure Portal](https://portal.azure.com/) にログインし、バージョンを戻したい BLOB が格納されているコンテナーの画面を表示します

2. BLOB (ファイル) の一覧が表示されるので、バージョンを戻したい BLOB をクリックします

3. BLOB の詳細画面が表示されるので、画面上部の \[**バージョン**\] タブをクリックします

    選択した BLOB のバージョンの一覧が表示されるので、目的のバージョンの右端にある \[**…**\] (その他の操作) をクリックし、表示されたメニューから \[**現在のバージョンに変更する**\] をクリックします

    ![Azure Storage アカウントの BLOB バージョンのリストア](images/Azure_Storage_blobVersion.png)

ここまでの手順で、BLOB の任意のバージョンを復元することができました。

この機能についての詳細は以下のドキュメントを参照してください。

* [BLOB のバージョン管理](https://learn.microsoft.com/ja-jp/azure/storage/blobs/versioning-overview)

<br>

### BLOB の上書きを防ぐ

BLOB 上書きされた際に元のバージョンに戻すのではなく、上書き自体を防ぎたい場合は、ポリシーを使用して BLOB の上書きを防ぐことができます。

詳しくは以下のドキュメントを参照してください。

* [**ビジネス クリティカルな BLOB データを書き込み 1 回、読み取り複数回 (WORM) の状態で保存する**](https://learn.microsoft.com/ja-jp/azure/storage/blobs/immutable-storage-overview)

<br>

### Azure アカウント内のすべての Blob コンテナーを復元する









Azure Storage Blob にはそれ固有のバックアップの仕組みがないため Azure で用意されているバックアップの仕組みを利用する必要があります。

そのために[バックアップ コンテナーの作成](https://learn.microsoft.com/ja-jp/azure/backup/create-manage-backup-vault#create-a-backup-vault)、作成したバックアップ コンテナーへの[アクセス制御設定](https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-configure-manage?tabs=operational-backup#grant-permissions-to-the-backup-vault-on-storage-accounts)、[バックアップ ポリシーの作成](https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-configure-manage?tabs=operational-backup#create-a-backup-policy)などの事前準備が必要です。

ここでは一連の手順について紹介します。

### バックアップ コンテナーの作成

バックアップ コンテナーは、Azure Backup によってサポートされる特定のワークロードのバックアップ データを格納する Azure のストレージ エンティティです。

バックアップ コンテナーを使用すると、管理オーバーヘッドを最小限に抑えながら、バックアップ データを簡単に整理できます。

バックアップ コンテナーの作成手順は以下の通りです。

\[**手順**\]

1. [Azure Portal](https://portal.azure.com/) にログインし、画面上部の検索ボックスに `バックアップ コンテナー` と入力し、表示された候補から \[**バックアップ コンテナー**\] をクリックします

    ![バックアップ コンテナーの検索](images/portal_backupContainer.png)

2. \[**バックアップ コンテナー**\] の画面が表示されるので、画面上部の \[**+ 作成**\] ボタンをクリックします

    ![バックアップ コンテナーの作成ボタン](images/BackupContaner_Create.png)

3. \[**バックアップ コンテナーの作成**\] 画面が表示されるので、各項目を以下のように設定します

    | 項目 | 設定値 |
    | --- | --- |
    | **サブスクリプション** | 使用しているサブスクリプションを選択 |
    | **リソース グループ** | `AOAI-AppEnv-handson` |
    | **バックアップ コンテナー名** | 'handson-backup-container' |
    | **リージョン** | \[**Japan East**\] |
    | **バックアップ ストレージの冗長性** | 任意のもの(※) |
    
    (※) この演習では `ローカル冗長` でかまいませんが、運用環境では `geo 冗長` 、もしくは `ゾーン冗長` を選択することをお勧めします。なお、この設定はバックアップ コンテナーの作成後に変更することができません。

    ![バックアップ コンテナーの作成](images/BackupContainer_Create_Settings.png)

    設定が完了したら、画面下部の \[**確認および作成**\] ボタンをクリックし、\[**作成**\] ボタンが表示されたらクリックします。

    デプロイが開始され、完了すると通知が表示されます。

ここまでの手順でバックアップ コンテナーを作成することができました。

<br>

## ストレージ アカウントでのバックアップ コンテナーへのアクセス許可の付与



<!--
https://learn.microsoft.com/ja-jp/samples/azure-samples/azure-search-dotnet-utilities/azure-search-backup-restore-index/

https://learn.microsoft.com/en-us/answers/questions/1792032/how-do-i-backup-data-of-azure-ai-search-service

https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-configure-manage?tabs=operational-backup


https://azure.github.io/jpazpaas/2024/01/25/backup-search-service.html

-->