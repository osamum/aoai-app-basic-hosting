# 演習 2-3 : バックアップの設定

システムのバックアップは稼働するソリューションに不可逆的な障害が発生した場合に備えて行われます。

バックアップされる情報はさまざまですが、必須となるのはその稼働中のシステム内にしか存在しない情報です。たとえば、アプリケーションが使用するデータベースの情報はもちろん、シームレスな復旧を望むのであれば処理中の状態データも必要となるでしょう。

この演習用アプリケーションで扱われる稼働中のシステム固有のデータはユーザーの会話履歴データと Azure AI Search のインデックス情報です。

Azure 上のリソースやアプリケーションのコード、接続情報、Azure Blob ストレージにアップロードしたデーターなどは[構築時に使用した Bicep](assets/prep-az-resource.bicep) や [RAG 検証用ダミーデータ](assets/RAG_TestData.txt)を使用して再デプロイ、再アップロードで同じものが展開できるので、バックアップの対象とするかどうかは運用ポリシー次第です。

よって、この演習用アプリケーションでは、ボットとユーザーとの会話履歴データと Azure AI Search のインデックス情報ということになりますが、アプリケーションのボットとユーザーとの会話履歴データはもともと揮発性のものとして作成してあるため、バックアップの対象とする必要はありません。

とはいえ、この演習では、一般的に使われるであろう、最大公約数的なアプリケーションの利用を考慮し、以下のバックアップの演習と説明を行います。

1. アプリケーションのバックアップ
2. Azure Storage Blob 上のデータのバックアップ
3. Azure AI Search インデックスのバックアップ

<br>

## 1. アプリケーションのバックアップ

Azure App Service では、アプリケーションのバックアップを自動で取得する仕組みが用意されており、これを利用することでバックアップのサービス、バックアップ先のストレージ等、個別に準備することなく、簡単にバックアップを取得することができます。

### App Service プランの変更

Azure App Service のバックアップ機能を利用するには、App Service プランが **Basic** もしくは **Standard** 以上である必要があります。

この演習でデプロイされた App Service は **Free** プランであるため、演習の前にプランを **Standard** に変更します。**Free** プランの場合 \[バックアップ\] メニューから直接プランの変更が行えますが、この画面内では実稼働むけの高価な Premium v3 プランしか選択できないため、ここでは \[**App Service プラン**\] メニューから変更します。

また、なぜ **Basic** ではなくレガシの **Standard** プランに変更するのかというと、**Basic** プランはではデプロイスロットが使用できないためです。
なお、今回変更する **Basic** プランはは開発やテストなどの負荷の低い用途向けとなるので、可用性設定の演習でより可用性の高い Premium v3 プランに再度変更します。


現在使用している App Service プランの変更は以下の手順で行います。

\[**手順**\]

1. [Azure Portal](https://portal.azure.com/) にログインします
2. この演習で使用している App Service のリソース画面を表示し、画面左のメニューから \[**App Service プラン**\] をクリックします

3. \[**App Service プラン**\] の画面に遷移するので、項目 \[**料金プラン**\] の `F1(スケールアップ)` のリンクをクリックします

    ![App Service プランの画面](images/AppSrv_Backup_upgrade.png)

4. \[**スケールアップ (App Service のプラン)**\] 画面に遷移し、App Service のプランの一覧が表示されるので \[**Standard (S1)**\] のチェックボックスにチェックをつけ、画面下の \[**選択**\] ボタンをクリックします

    ![App Service プランの一覧](images/AppSrv_plan_standerd.png)

    \[価格プランのアップグレード\] ボックスが表示されるので、 \[**アップグレード**\] ボタンをクリックします。
    
    「プランが更新されました」と、通知表示されれば完了です。
    
    なお、画面はとくに別の画面には遷移しません。

ここまでの手順で App Service のプランを **Free** から **Standard** に変更することができました。

<br>

### バックアップの取得とリストア

この演習では、現在正常に動作しているアプリケーションに対し、リストア可能なバックアップが取得されていることを確認します。

その後、アプリケーションを破壊して動作不能とし、バックアップを使用してリストアを行い復旧させます。

\[**手順**\]

1. [Azure Portal](https://portal.azure.com/) にログインします

2. この演習で使用している App Service のリソース画面を表示し、画面左のメニューから \[**バックアップ**\] をクリックします

    \[**バックアップ**\] の画面に遷移し、自動で取得されたバックアップの一覧が表示されていることを確認します。

    既にこのバックアップを使用してリストアを行うことができますが、バックアップがない場合や、任意のタイミングやバックアップの保存場所を指定したい場合は部面上部の \[カスタム バックアップの構成\] ボタンをクリックして設定を行うことができます。

    ![App Service バックアップの画面](images/AppSrv_custom_backup.png)

    **既にバックアップがリストされている場合はなにもしなくてかまいません**。

3. バックアップが取得されていることを確認したら、アプリケーションを破壊します

    画面左のメニューから \[**開発ツール**\] - \[**コンソール**\] をクリックし、遷移した場面内の \[**移動**\] リンクをクリックします

4. kudu の画面が別のタブで開くので、画面上部のメニューから \[**Bash**\] をクリックします

    ![kudo のトップ画面](images/kudu_top.png)

5. Bash の画面に遷移したら、以下のコマンドを入力してアプリケーションの **site** ディレクトリを削除します

    ```bash
    rm -rf site
    ```

    ![アプリケーションの削除](images/kudu_bash.png)
    
    アプリケーションのファイルが削除され、アプリケーションは動作不能となります。

6. 演習用アプリケーションの UR+ にアクセスし、レスポンスが返らなくなっていることを確認します

    ![アプリケーションの動作確認](images/AppSrv_not_working.png)

7. 再度、Azure Portal の App Service の画面に戻り、画面左のメニューから \[**バックアップ**\] をクリックします

    画面上部の \[**復元**\] ボタンか、リストされているバックアップの一覧の任意のバックアップの \[**復元**\] ボタンをクリックします。

    ![App Service バックアップの選択](images/AppSrv_choose_backup.png)

8.  \[**バックアップから復元**\] ブレードが表示されます。

    今回は App Service ログの設定を行っているので \[**サイト構成の復元**\] にチェックをつけます。(なお、カスタム バックアップの場合は \[**サイト構成の復元**\] は表示されません)

    また、\[**デプロイ スロット\***\] に表示されている名前を覚えておいてください。これは実際にバックアップがリストアされる際に使用されるデプロイスロット スロット名です。デプロイ スロットについては演習 3 で詳しく説明します。
    
    \[**復元**\] ボタンをクリックします

    ![App Service バックアップの復元](images/AppService_Restore_Settings.png)

9. 復元が完了したという通知はとくにされないので、App Service の画面左のメニューから \[**デプロイ スロット**\] をクリックします

    デプロイ スロットの一覧が表示されるので、先ほど覚えておいたデプロイ スロット名がリストにあることを確認し、クリックします

    ![App Service デプロイ スロットの画面](images/AppService-Restore-Slot.png)

10. 選択したデプロイ スロットの \[**概要**\] 画面が表示されるので、\[**既定のドメイン**\] のリンクをクリックして、アプリケーションが正常に動作していることを確認し、確認が取れたら画面上部 \[**スワップ**\] ボタンをクリックします(※)

    ![App Service デプロイ スロットの概要](images/AppService_Restore_Swap.png)

    (※) これまで使用していた App Service のインスタンスと、リストアの際に生成されたデプロイ スロットのインスタンスは、**Production** と **Staging** の関係となっており、スワップを行うことで、デプロイ スロットのインスタンスが Production となり、これまでの Production のインスタンスが Staging となります。このようにデプロイ スロットを使用することで、バックアップからのリストアを行う際に、アプリケーションの停止時間を最小限に抑えることができます。

11. \[**スワップ**\] ブレードが表示されるので、画面下部の \[**Start Swap**\] ボタンをクリックします

12. スワップが完了した通知を確認後、演習用アプリケーションの \[**概要**\] 画面から \[**既定のドメイン**\] のリンクをクリックし、アプリケーションの画面が正常に表示されることを確認します。

ここまでの手順で、App Service のバックアップの設定とリストアの作業は完了です。

カスタム バックアップなどのその他の設定や手順につきましては、以下のドキュメントを参照してください。    

* [**Azure App Service でアプリをバックアップおよび復元する**](https://learn.microsoft.com/ja-jp/azure/app-service/manage-backup?tabs=portal#automatic-vs-custom-backups)

<br>

## 2. Azure Storage Blob のデータ保護

Azure Storage Blob にはそれ固有のバックアップの仕組みありません。よって、Azure Storage Blob のバックアップを取得するには Azure Backup サービスを利用する必要があります。

しかし、Azure Storage には、削除されたデータを復元したり、上書きを防いだり、上書きされたデータであっても任意のバージョンを復元することができるデータ保護機能が用意されています。

Azure Storage Blob のバックアップ方法を説明する前に、Azure Storage Blob の[データ保護機能](https://learn.microsoft.com/ja-jp/azure/storage/blobs/data-protection-overview)について説明します。

<br>

### 論理的な削除 (ソフト デリート)

Azure Storage アカウントの論理的な削除機能を有効にしておくことで、削除された BLOB データやコンテナーを任意の期間復元することができます。

この機能は既定で有効になっており、設定内容は、Azure Storage アカウント画面の \[データ管理\] - \[**データ保護**\] から確認できます。

![Azure Storage アカウントのソフト デリート](images/Azure_Storage_softDelete.png)

論理的な削除が有効な状態で削除されたコンテナー、もしくは BLOB を復元する手順は以下のとおりです。

1. [Azure Portal](https://portal.azure.com/) にログインし、復元対象となるコンテナーもしくは BLOB が格納されている Azure Storage アカウントのリソース画面を表示します

2. 画面左のメニューから \[**コンテナー**\] をクリックし、コンテナーの一覧が表示されたたら、リスト上部の右側にある \[**アクティブなコンテナーのみを表示する**\] ドロップダウンボックスの内容を \[**アクティブな、および削除されたコンテナーを表示する**\] に変更します

3. 削除されたコンテナーがリストに表示されるので、復元したいコンテナーの右端にある \[**…**\] (その他の操作) をクリックし、表示されたメニューから \[**復元**\] をクリックします

    ![Azure Storage アカウントの削除されたコンテナー](images/Azure_Storage_restoreContainer.png)

ここまでの手順で削除されたコンテナーを復元することができました。

BLOB も同様の手順で復元することができます。

ただし、論理的な削除はあくまで削除されたデータを復元するための機能であり、上書きされたデータを復元することはできません。

この機能についての詳細は以下のドキュメントを参照してください。

* [コンテナーの論理的な削除](https://learn.microsoft.com/ja-jp/azure/storage/blobs/soft-delete-container-overview)

* [BLOB の論理的な削除](https://learn.microsoft.com/ja-jp/azure/storage/blobs/soft-delete-blob-overview)


<br>

### BLOB を任意のバージョンに復元する

Blob Storage のバージョン管理を有効にすることで上書きされた BLOB の任意のバージョンを復元することができます。

この機能は、既定では有効になっていないので、必要に応じて有効にする必要があります。この機能を有効にするには、Azure Storage アカウント画面の \[データ管理\] - \[**データ保護**\] から行うことができます。

![Azure Storage アカウントのバージョン管理](images/Azure_Storage_version.png)

Blob Storage のバージョン管理が有効な状態で、任意のバージョンの BLOB を復元する手順は以下のとおりです。

1. [Azure Portal](https://portal.azure.com/) にログインし、バージョンを戻したい BLOB が格納されているコンテナーの画面を表示します

2. BLOB (ファイル) の一覧が表示されるので、バージョンを戻したい BLOB をクリックします

3. BLOB の詳細画面が表示されるので、画面上部の \[**バージョン**\] タブをクリックします

    選択した BLOB のバージョンの一覧が表示されるので、目的のバージョンの右端にある \[**…**\] (その他の操作) をクリックし、表示されたメニューから \[**現在のバージョンに変更する**\] をクリックします

    ![Azure Storage アカウントの BLOB バージョンのリストア](images/Azure_Storage_blobVersion.png)

ここまでの手順で、BLOB の任意のバージョンを復元することができました。

この機能についての詳細は以下のドキュメントを参照してください。

* [BLOB のバージョン管理](https://learn.microsoft.com/ja-jp/azure/storage/blobs/versioning-overview)

<br>

### BLOB の上書きを防ぐ

BLOB 上書きされた際に元のバージョンに戻すのではなく、上書き自体を防ぎたい場合は、ポリシーを使用して BLOB の上書きを防ぐことができます。

詳しくは以下のドキュメントを参照してください。

* [**ビジネス クリティカルな BLOB データを書き込み 1 回、読み取り複数回 (WORM) の状態で保存する**](https://learn.microsoft.com/ja-jp/azure/storage/blobs/immutable-storage-overview)

<br>

### Azure アカウント内のすべての Blob コンテナーを復元する









Azure Storage Blob にはそれ固有のバックアップの仕組みがないため Azure で用意されているバックアップの仕組みを利用する必要があります。

そのために[バックアップ コンテナーの作成](https://learn.microsoft.com/ja-jp/azure/backup/create-manage-backup-vault#create-a-backup-vault)、作成したバックアップ コンテナーへの[アクセス制御設定](https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-configure-manage?tabs=operational-backup#grant-permissions-to-the-backup-vault-on-storage-accounts)、[バックアップ ポリシーの作成](https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-configure-manage?tabs=operational-backup#create-a-backup-policy)などの事前準備が必要です。

ここでは一連の手順について紹介します。

### バックアップ コンテナーの作成

バックアップ コンテナーは、Azure Backup によってサポートされる特定のワークロードのバックアップ データを格納する Azure のストレージ エンティティです。

バックアップ コンテナーを使用すると、管理オーバーヘッドを最小限に抑えながら、バックアップ データを簡単に整理できます。

バックアップ コンテナーの作成手順は以下の通りです。

\[**手順**\]

1. [Azure Portal](https://portal.azure.com/) にログインし、画面上部の検索ボックスに `バックアップ コンテナー` と入力し、表示された候補から \[**バックアップ コンテナー**\] をクリックします

    ![バックアップ コンテナーの検索](images/portal_backupContainer.png)

2. \[**バックアップ コンテナー**\] の画面が表示されるので、画面上部の \[**+ 作成**\] ボタンをクリックします

    ![バックアップ コンテナーの作成ボタン](images/BackupContaner_Create.png)

3. \[**バックアップ コンテナーの作成**\] 画面が表示されるので、各項目を以下のように設定します

    | 項目 | 設定値 |
    | --- | --- |
    | **サブスクリプション** | 使用しているサブスクリプションを選択 |
    | **リソース グループ** | `AOAI-AppEnv-handson` |
    | **バックアップ コンテナー名** | 'handson-backup-container' |
    | **リージョン** | \[**Japan East**\] |
    | **バックアップ ストレージの冗長性** | 任意のもの(※) |
    
    (※) この演習では `ローカル冗長` でかまいませんが、運用環境では `geo 冗長` 、もしくは `ゾーン冗長` を選択することをお勧めします。なお、この設定はバックアップ コンテナーの作成後に変更することができません。

    ![バックアップ コンテナーの作成](images/BackupContainer_Create_Settings.png)

    設定が完了したら、画面下部の \[**確認および作成**\] ボタンをクリックし、\[**作成**\] ボタンが表示されたらクリックします。

    デプロイが開始され、完了すると通知が表示されます。

ここまでの手順でバックアップ コンテナーを作成することができました。

<br>

## ストレージ アカウントでのバックアップ コンテナーへのアクセス許可の付与



<!--
https://learn.microsoft.com/ja-jp/samples/azure-samples/azure-search-dotnet-utilities/azure-search-backup-restore-index/

https://learn.microsoft.com/en-us/answers/questions/1792032/how-do-i-backup-data-of-azure-ai-search-service

https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-configure-manage?tabs=operational-backup


https://azure.github.io/jpazpaas/2024/01/25/backup-search-service.html

-->